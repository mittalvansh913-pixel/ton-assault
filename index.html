<script>
let sound=true;

let player={
  name:"Player",
  hp:100,max:100,
  coins:0,gems:0,
  level:1,exp:0,
  damage:10,
  energy:10,
  weapon:"sword",
  skill:false,
  character:"hero",
  kills:0,
  refCode:"",
  refCount:0
};

let zombie={
  hp:30,max:30,
  damage:5,
  boss:false
};

let lastAd=0;

/* LOAD */
let save=localStorage.getItem("zf");
if(save) player=JSON.parse(save);
if(!player.refCode) player.refCode="ZF"+Math.random().toString(36).substr(2,5).toUpperCase();

/* UPDATE UI */
function update(){
  playerName.textContent=player.name;
  level.textContent=player.level;
  coins.textContent=player.coins;
  gems.textContent=player.gems;
  hp.textContent=player.hp;
  hpmax.textContent=player.max;
  hpbar.style.width=(player.hp/player.max*100)+"%";
  zhp.textContent=zombie.hp+"/"+zombie.max;
  zbar.style.width=(zombie.hp/zombie.max*100)+"%";
  localStorage.setItem("zf",JSON.stringify(player));
}

/* SPAWN ZOMBIE */
function spawnZombie(){
  zombie.boss = player.kills>0 && player.kills%5===0;
  zombie.max = zombie.boss ? 150+player.level*20 : 30+player.level*10;
  zombie.hp = zombie.max;
  zombieChar.textContent = zombie.boss ? "ðŸ‘¹" : "ðŸ§Ÿ";
  if(zombie.boss) toastMsg("ðŸ‘¹ BOSS ZOMBIE!");
}

/* ATTACK */
function attack(){
  if(player.energy<=0) return toastMsg("âš¡ No Energy");

  player.energy--;
  playerChar.classList.add("attack");
  zombieChar.classList.add("hit");

  let dmg = player.damage;
  let crit = player.skill && Math.random()<0.25;
  if(crit) dmg*=2;

  zombie.hp -= dmg;
  floatText((crit?"âš¡ ":"-")+dmg,zombieChar);

  if(zombie.hp<=0){
    player.kills++;
    player.coins += zombie.boss ? 50 : 10;
    player.exp += 20;
    levelCheck();
    coinSound();
    toastMsg(zombie.boss?"+50ðŸ’° Boss":"+10ðŸ’°");
    spawnZombie();
  }

  setTimeout(()=>{
    playerChar.classList.remove("attack");
    zombieChar.classList.remove("hit");
  },200);

  update();
}

/* LEVEL UP */
function levelCheck(){
  if(player.exp>=player.level*100){
    player.exp=0;
    player.level++;
    player.max+=20;
    player.hp=player.max;
    player.damage+=2;
    toastMsg("â­ LEVEL UP!");
  }
}

/* ENERGY REGEN */
setInterval(()=>{
  if(player.energy<10) player.energy++;
},4000);

/* WEAPONS */
function equipWeapon(type){
  if(type==="axe"){
    if(player.coins<200) return toastMsg("Need 200ðŸ’°");
    player.coins-=200;
    player.weapon="axe";
    player.damage=15;
    toastMsg("ðŸª“ Axe Equipped");
  }
  update();
}

/* SKILLS */
function unlockSkill(){
  if(player.coins<300) return toastMsg("Need 300ðŸ’°");
  player.coins-=300;
  player.skill=true;
  toastMsg("âœ¨ Skill Activated");
  update();
}

/* CHARACTERS */
function selectCharacter(c){
  player.character=c;
  if(c==="ninja"){
    player.damage+=3;
    player.max-=10;
  }
  toastMsg("ðŸ§™ Character Selected");
  update();
}

/* FLOAT TEXT */
function floatText(txt,el){
  let d=document.createElement("div");
  d.className="float";
  d.textContent=txt;
  el.appendChild(d);
  setTimeout(()=>d.remove(),1000);
}

/* EARNING */
function watchAd(){
  if(Date.now()-lastAd<30000) return toastMsg("â³ Wait");
  lastAd=Date.now();
  player.coins+=20;
  toastMsg("+20ðŸ’°");
  update();
}
function daily(){
  let d=localStorage.getItem("daily")||0;
  if(Date.now()-d<86400000) return toastMsg("Tomorrow");
  player.coins+=50;
  localStorage.setItem("daily",Date.now());
  toastMsg("+50ðŸ’°");
  update();
}
function spin(){
  if(player.gems<1) return toastMsg("Need 1ðŸ’Ž");
  player.gems--;
  let r=[10,20,50,0][Math.floor(Math.random()*4)];
  player.coins+=r;
  toastMsg("Won "+r+"ðŸ’°");
  update();
}

/* REFERRAL */
function openReferral(){
  refModal.style.display="flex";
  refCode.textContent=player.refCode;
  refLink.value="https://yourgame.site/?ref="+player.refCode;
  refCount.textContent=player.refCount;
}
function confirmInvite(){
  player.refCount++;
  player.coins+=50;
  toastMsg("+50ðŸ’° Referral");
  update();
}

/* SETTINGS */
function openSettings(){
  settingsModal.style.display="flex";
  nameInput.value=player.name;
}
function saveSettings(){
  player.name=nameInput.value||"Player";
  toastMsg("Settings Saved");
  closeAll();
  update();
}
function toggleSound(){
  sound=!sound;
  toastMsg(sound?"ðŸ”Š Sound ON":"ðŸ”‡ Sound OFF");
}
function coinSound(){
  if(!sound) return;
  new Audio("https://assets.mixkit.co/sfx/preview/mixkit-coin-win-notification-1992.mp3").play();
}

/* UTILS */
function closeAll(){
  document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}
function toastMsg(t){
  toast.textContent=t;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),1500);
}

/* INIT */
spawnZombie();
update();
</script>
