<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zombie Fighter</title>

<style>
body{
margin:0;font-family:Arial;color:#fff;overflow:hidden;
background:linear-gradient(#2b1055,#1a043a);
}

/* BACKGROUND */
.bg span{
position:fixed;width:10px;height:10px;
background:rgba(255,255,255,0.15);
border-radius:50%;
animation:float 15s linear infinite;
}
@keyframes float{
from{transform:translateY(110vh)}
to{transform:translateY(-10vh)}
}

.container{max-width:420px;margin:auto;padding:15px;text-align:center;position:relative;z-index:5}
.top{background:rgba(0,0,0,.4);border-radius:12px;padding:12px;display:flex;justify-content:space-between}
.stat{font-weight:bold;font-size:13px}

.bar{background:#444;border-radius:8px;overflow:hidden;height:10px;margin-top:5px}
.bar div{height:100%;transition:width 0.3s}

/* ‚ú® NEW: XP Bar styling */
.xp-bar-container{margin:5px 0}
.xp-bar{background:#444;border-radius:8px;overflow:hidden;height:8px;margin-top:3px}
.xp-bar div{height:100%;background:linear-gradient(90deg, #ffc107, #ff9800);transition:width 0.5s}

/* ‚ú® NEW: Energy Bar styling */
.energy-bar-container{margin:5px 0}
.energy-bar{background:#444;border-radius:8px;overflow:hidden;height:8px;margin-top:3px}
.energy-bar div{height:100%;background:linear-gradient(90deg, #00ff88, #00ccff);transition:width 0.5s}

/* ‚ú® NEW: Smooth energy regeneration animation */
@keyframes energyRegen {
0% { opacity: 0.5; }
50% { opacity: 1; }
100% { opacity: 0.5; }
}
.energy-regen {
animation: energyRegen 1s infinite;
}

/* ‚ú® NEW: Modal animations */
.modal{
position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,.85);
display:none;align-items:center;justify-content:center;z-index:2000;
overflow-y:auto;padding:20px;box-sizing:border-box;
opacity:0;visibility:hidden;
transition:opacity 0.3s ease, visibility 0.3s ease;
}
.modal.show{
display:flex;opacity:1;visibility:visible;
}
.modal-box{
background:#1a1a2e;padding:20px;border-radius:12px;width:100%;max-width:380px;
max-height:90vh;overflow-y:auto;
transform:translateY(20px);
transition:transform 0.3s ease;
}
.modal.show .modal-box{
transform:translateY(0);
}

/* ‚ú® FIXED: Button Responsiveness */
button, .side-btn, .bottom-btn, .action-btn {
transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1) !important;
touch-action: manipulation !important;
-webkit-tap-highlight-color: transparent !important;
user-select: none !important;
}

button:active, .side-btn:active, .bottom-btn:active, .action-btn:active {
transform: scale(0.95) !important;
}

/* Press animation */
@keyframes buttonPress {
0% { transform: scale(1); }
50% { transform: scale(0.95); }
100% { transform: scale(1); }
}
.button-press {
animation: buttonPress 0.2s ease;
}

/* Glow effect for active buttons */
.glow {
box-shadow: 0 0 15px rgba(255, 215, 0, 0.7) !important;
}

/* ‚ú® FIXED: Attack button specific fixes */
#axeAttackButton {
transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1) !important;
touch-action: manipulation !important;
-webkit-tap-highlight-color: transparent !important;
position: relative;
z-index: 10;
pointer-events: auto !important;
}

#axeAttackButton:active {
transform: scale(0.95) !important;
box-shadow: inset 0 0 15px rgba(0,0,0,0.7) !important;
}

/* Remove any overlay that might block clicks */
.button-click-protected:after {
display: none !important;
}

/* Ensure touch areas are large enough */
.side-btn, .action-btn {
min-width: 50px;
min-height: 50px;
}

.bottom-btn {
min-height: 44px;
padding: 12px 0;
}

.game{background:rgba(0,0,0,.4);border-radius:12px;padding:20px;margin:10px 0}
.fighters{font-size:48px;display:flex;justify-content:space-between;align-items:center}

#playerChar.attack{animation:attack .2s}
#zombieChar.hit{animation:hit .2s}

/* ‚ú® NEW: Character icon styling */
.character-icon{
font-size:48px;
width:60px;
height:60px;
display:flex;
align-items:center;
justify-content:center;
}
.ninja-icon{
width:60px;
height:60px;
object-fit:contain;
}

/* ‚ú® NEW: Skin preview styling */
.skin-preview{
width:60px;
height:60px;
display:flex;
align-items:center;
justify-content:center;
font-size:36px;
margin:0 auto 10px;
border-radius:10px;
border:2px solid #444;
background:rgba(255,255,255,0.05);
}
.skin-preview.active{
border-color:#ffc107;
background:rgba(255,193,7,0.1);
}
.skin-preview.owned{
border-color:#4caf50;
}
.skin-preview img{
width:50px;
height:50px;
object-fit:contain;
}

/* ‚ú® NEW: Shop tabs */
.shop-tabs{
display:flex;
background:rgba(255,255,255,0.05);
border-radius:8px;
padding:5px;
margin-bottom:15px;
}
.shop-tab{
flex:1;
text-align:center;
padding:10px;
border-radius:6px;
cursor:pointer;
font-weight:bold;
transition:all 0.3s;
}
.shop-tab.active{
background:#1e88e5;
}

/* ‚ú® NEW: Profile styling */
.profile-header{
text-align:center;
margin-bottom:20px;
}
.profile-avatar{
width:80px;
height:80px;
margin:0 auto 15px;
border-radius:50%;
border:3px solid #ffc107;
display:flex;
align-items:center;
justify-content:center;
font-size:48px;
background:rgba(255,255,255,0.05);
}
.profile-avatar img{
width:70px;
height:70px;
object-fit:contain;
border-radius:50%;
}
.profile-name{
font-size:24px;
font-weight:bold;
margin-bottom:5px;
}
.profile-level{
color:#ffc107;
font-size:16px;
margin-bottom:15px;
}

/* ‚ú® NEW: Daily reward animation */
@keyframes rewardPulse {
0% { transform: scale(1); }
50% { transform: scale(1.1); }
100% { transform: scale(1); }
}
.reward-claimed{
animation: rewardPulse 0.5s ease 3;
}

/* ‚ú® NEW: Screen shake on crit */
.game.shake{animation:shake 0.3s}
@keyframes shake{
0%, 100%{transform:translateX(0)}
25%{transform:translateX(-5px)}
75%{transform:translateX(5px)}
}

/* ‚ú® NEW: Level up glow effect */
.game.levelup{animation:levelupGlow 0.8s}
@keyframes levelupGlow{
0%, 100%{box-shadow:0 0 0 rgba(255,193,7,0)}
50%{box-shadow:0 0 30px rgba(255,193,7,0.8)}
}

/* ‚ú® NEW: Low HP warning */
.hp-low{animation:hpWarning 1s infinite}
@keyframes hpWarning{
0%, 100%{color:#fff}
50%{color:#ff5252}
}

@keyframes attack{50%{transform:translateX(20px)}}
@keyframes hit{50%{transform:translateX(-15px)}}

button{padding:10px 20px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;background:#1e88e5;color:#fff;font-size:16px}
button:active{transform:scale(0.95)}
button:disabled{opacity:0.5;cursor:not-allowed}

/* ‚ú® NEW: Button click protection class */
button.button-click-protected:disabled{
position:relative;
}

/* SIDE MENUS */
.side-menu{position:fixed;top:30%;display:flex;flex-direction:column;gap:10px;z-index:999}
.side-menu.left{left:10px}
.side-menu.right{right:10px}
.side-btn{
width:50px;height:50px;border-radius:50%;
background:#1e88e5;color:#fff;
display:flex;align-items:center;justify-content:center;
font-size:20px;cursor:pointer;
box-shadow:0 4px 8px rgba(0,0,0,0.3);
}
.side-btn:active{transform:scale(0.9)}

/* MODALS */
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.modal-header h2{margin:0;font-size:20px}
.close-btn{background:#ff5252;color:#fff;border:none;padding:5px 15px;border-radius:8px;cursor:pointer;font-size:18px}

/* ITEM CARDS */
.item-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.item-card{
background:rgba(255,255,255,0.05);border-radius:10px;padding:15px;
border:2px solid #444;position:relative;
transition:transform 0.2s ease, box-shadow 0.2s ease;
}
.item-card:active{transform:scale(0.98)}
.item-card.owned{border-color:#4caf50}
.item-card.equipped{border-color:#ffc107;background:rgba(255,193,7,0.1)}
.item-card .icon{font-size:40px}
.item-card .name{font-weight:bold;margin:5px 0}
.item-card .desc{font-size:12px;color:#aaa}
.item-card .price{color:#ffc107;margin-top:8px}
.item-card button{padding:6px 12px;font-size:12px;margin-top:8px;width:100%}
.item-card .badge{
position:absolute;top:5px;right:5px;
background:#ffc107;color:#000;padding:2px 6px;
border-radius:5px;font-size:10px;font-weight:bold;
}

/* SKILL ITEMS */
.skill-item{
background:rgba(255,255,255,0.05);border-radius:10px;padding:12px;
border:2px solid #444;margin-bottom:10px;
transition:transform 0.2s ease, box-shadow 0.2s ease;
}
.skill-item:active{transform:scale(0.98)}
.skill-item .skill-header{display:flex;justify-content:space-between;align-items:center}
.skill-item .skill-name{font-weight:bold;font-size:16px}
.skill-item .skill-level{color:#4caf50;font-size:14px}
.skill-item .skill-desc{font-size:13px;color:#aaa;margin:5px 0}
.skill-item button{padding:6px 12px;font-size:12px;width:100%;margin-top:5px}

/* STATS PAGE */
.stat-row{
display:flex;justify-content:space-between;
background:rgba(255,255,255,0.05);padding:12px;
border-radius:8px;margin-bottom:8px;
}
.stat-row .label{color:#aaa}
.stat-row .value{font-weight:bold;color:#4caf50}

/* VIP TIER STYLES */
.vip-tier{
background:rgba(255,255,255,0.05);
border-radius:10px;
padding:15px;
margin-bottom:10px;
border:2px solid #444;
transition:transform 0.2s ease, box-shadow 0.2s ease;
}
.vip-tier:active{transform:scale(0.98)}
.vip-tier.active{
border-color:#ffc107;
background:rgba(255,193,7,0.1);
}
.vip-tier.locked{
opacity:0.6;
border-color:#666;
}
.vip-tier-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:10px;
}
.vip-tier-name{
font-weight:bold;
font-size:18px;
}
.vip-tier-bonus{
color:#4caf50;
font-size:14px;
}
.vip-tier-price{
color:#ffc107;
font-weight:bold;
}
.vip-tier-desc{
font-size:12px;
color:#aaa;
margin-top:8px;
}

/* ACHIEVEMENT STYLES */
.achievement-item{
background:rgba(255,255,255,0.05);
border-radius:10px;
padding:15px;
margin-bottom:10px;
border:2px solid #444;
transition:transform 0.2s ease, box-shadow 0.2s ease;
}
.achievement-item:active{transform:scale(0.98)}
.achievement-item.completed{
border-color:#4caf50;
background:rgba(76,175,80,0.1);
}
.achievement-item.claimed{
border-color:#ffc107;
background:rgba(255,193,7,0.1);
}
.achievement-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:8px;
}
.achievement-name{
font-weight:bold;
font-size:16px;
}
.achievement-reward{
color:#ffc107;
font-size:14px;
font-weight:bold;
}
.achievement-desc{
font-size:12px;
color:#aaa;
margin-bottom:8px;
}
.achievement-progress{
background:#444;
border-radius:5px;
height:10px;
overflow:hidden;
margin-bottom:8px;
}
.achievement-progress-bar{
height:100%;
background:linear-gradient(90deg, #4caf50, #8bc34a);
transition:width 0.5s;
}

/* SETTINGS */
.setting-item{
background:rgba(255,255,255,0.05);padding:12px;
border-radius:8px;margin-bottom:10px;
}
.setting-item label{display:flex;justify-content:space-between;align-items:center}
.setting-item input[type="text"]{
width:100%;padding:8px;border-radius:6px;border:1px solid #444;
background:#0f0f1e;color:#fff;margin-top:5px;
}
.setting-item input[type="checkbox"]{
width:40px;height:20px;cursor:pointer;
}

/* REFERRAL */
.referral-code{
background:rgba(255,255,255,0.1);padding:15px;
border-radius:8px;text-align:center;margin:10px 0;
}
.referral-code .code{
font-size:24px;font-weight:bold;letter-spacing:2px;
color:#ffc107;margin:10px 0;
}

/* ‚ú® FIXED: SPIN WHEEL STYLES - 6 SLOTS WITH BETTER READABILITY */
.wheel-container{
position:relative;
width:280px;
height:280px;
margin:20px auto;
}
.wheel{
width:100%;
height:100%;
border-radius:50%;
position:relative;
overflow:hidden;
box-shadow:0 0 20px rgba(255,193,7,0.5);
transition:transform 3s cubic-bezier(0.17, 0.67, 0.12, 0.99);
}
.wheel-slice{
position:absolute;
width:50%;
height:50%;
transform-origin:100% 100%;
clip-path:polygon(0 0, 100% 0, 100% 100%);
display:flex;
align-items:center;
justify-content:center;
font-weight:bold;
font-size:22px;
color:#000;
text-shadow:1px 1px 2px rgba(255,255,255,0.8);
}
.wheel-pointer{
position:absolute;
top:-10px;
left:50%;
transform:translateX(-50%);
width:0;
height:0;
border-left:20px solid transparent;
border-right:20px solid transparent;
border-top:35px solid #ff5252;
z-index:10;
filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));
}
.wheel-center{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%, -50%);
width:70px;
height:70px;
background:#1a1a2e;
border-radius:50%;
border:4px solid #ffc107;
display:flex;
align-items:center;
justify-content:center;
font-size:24px;
z-index:5;
box-shadow:0 0 15px rgba(255,193,7,0.5);
}
.wheel-center img{
width:50px;
height:50px;
object-fit:contain;
}
.spin-result{
font-size:24px;
font-weight:bold;
color:#ffc107;
margin-top:15px;
min-height:30px;
text-align:center;
}
.spin-timer{
font-size:14px;
color:#aaa;
margin-top:10px;
display:flex;
align-items:center;
justify-content:center;
gap:5px;
}
.spin-timer.active{
color:#4caf50;
font-weight:bold;
}
.spin-timer.locked{
color:#ff5252;
}

/* FLOAT DAMAGE */
.float{
position:absolute;
color:#ff5252;
font-weight:bold;
font-size:20px;
animation:floatUp 1s forwards;
pointer-events:none;
}
@keyframes floatUp{
to{transform:translateY(-40px);opacity:0}
}

/* TOAST */
#toast{
position:fixed;bottom:80px;left:50%;
transform:translateX(-50%);
background:#000;padding:10px 20px;border-radius:20px;
opacity:0;transition:.3s;z-index:3000;
}
#toast.show{opacity:1}

/* BOTTOM MENU */
.bottom-menu{
position:fixed;
bottom:0;left:0;width:100%;
background:rgba(0,0,0,.7);
border-top:2px solid #555;
display:flex;
justify-content:space-around;
padding:8px 0;
z-index:1000;
}
.bottom-btn{
flex:1;margin:0 6px;
border:1px solid #666;
border-radius:12px;
background:#111;
padding:6px 0;
text-align:center;
font-size:14px;
cursor:pointer;
}
.bottom-btn:active{background:#222}

/* MAIN ACTION ROW */
.main-action-row {
position: fixed;
bottom: 70px;
left: 0;
width: 100%;
display: flex;
justify-content: center;
gap: 15px;
z-index: 100;
}
.action-btn {
width: 70px;
height: 70px;
border-radius: 50%;
font-size: 30px;
display: flex;
align-items: center;
justify-content: center;
border: none;
cursor: pointer;
box-shadow: 0 4px 8px rgba(0,0,0,0.5);
}
.action-btn:active { transform: scale(0.95); }

/* WALLET BUTTON */
.wallet-btn {
position: absolute;
top: 15px;
right: 15px;
background: none;
border: none;
color: #fff;
font-size: 24px;
cursor: pointer;
padding: 8px;
z-index: 10;
}

/* CONFIRM DIALOG */
.confirm-dialog{
background:#1a1a2e;padding:20px;border-radius:12px;
text-align:center;max-width:300px;
}
.confirm-dialog h3{margin-top:0}
.confirm-dialog .buttons{display:flex;gap:10px;margin-top:15px}
.confirm-dialog button{flex:1;padding:10px}

/* SKIN PACKS */
.skin-pack-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 10px;
margin-top: 15px;
}
.skin-pack-card {
background: rgba(255,255,255,0.05);
border-radius: 10px;
padding: 15px;
border: 2px solid #444;
text-align: center;
}
.skin-pack-card.common { border-color: #1e88e5; }
.skin-pack-card.rare { border-color: #4caf50; }
.skin-pack-card.epic { border-color: #9c27b0; }
.skin-pack-card.legendary { border-color: #ffc107; }
.skin-pack-icon {
font-size: 36px;
margin-bottom: 10px;
}
.skin-pack-name {
font-weight: bold;
margin-bottom: 5px;
}
.skin-pack-rarity {
font-size: 12px;
padding: 2px 8px;
border-radius: 10px;
display: inline-block;
margin-bottom: 8px;
}
.skin-pack-rarity.common { background: #1e88e5; }
.skin-pack-rarity.rare { background: #4caf50; }
.skin-pack-rarity.epic { background: #9c27b0; }
.skin-pack-rarity.legendary { background: #ffc107; color: #000; }

/* ‚ú® FIXED: Layout Safety */
.container {
padding-bottom: 80px;
}

/* Prevent text selection during gameplay */
.game, .fighters, .character-icon {
user-select: none;
-webkit-user-select: none;
}
</style>
</head>

<body>

<div class="bg">
<script>
for(let i=0;i<40;i++){
document.write(`<span style="left:${Math.random()*100}%;animation-delay:${Math.random()*10}s"></span>`);
}
</script>
</div>

<div class="container">
<div class="top">
<div style="display:flex;align-items:center;gap:10px;">
<div class="stat">üë§ <span id="playerName">Player</span></div>
<div class="stat">‚≠ê <span id="level">1</span></div>
</div>
<div style="display:flex;align-items:center;gap:10px;">
<div class="stat">üí∞ <span id="coins">0</span> | üíé <span id="gems">0</span></div>
<!-- Wallet Button -->
<button class="wallet-btn" onclick="openWallet()">üí∞</button>
</div>
</div>

<!-- ‚ú® NEW: XP Progress Bar -->
<div class="xp-bar-container">
‚ö° XP <span id="xp">0</span>/<span id="xpmax">100</span>
<div class="xp-bar"><div id="xpbar" style="width:0%;background:linear-gradient(90deg, #ffc107, #ff9800)"></div></div>
</div>

<div id="hpContainer">
<span id="hpLabel">‚ù§Ô∏è HP</span> <span id="hp">100</span>/<span id="hpmax">100</span>
<div class="bar"><div id="hpbar" style="width:100%;background:red"></div></div>
</div>

<!-- ‚ú® NEW: Energy Progress Bar -->
<div class="energy-bar-container">
‚ö° Energy <span id="energy">100</span>/<span id="energymax">100</span>
<div class="energy-bar"><div id="energybar" style="width:100%;background:linear-gradient(90deg, #00ff88, #00ccff)"></div></div>
</div>

<div class="game" id="gameContainer">
<div class="fighters">
<div id="playerChar" class="character-icon">ü¶∏‚Äç‚ôÇÔ∏è</div> ‚öîÔ∏è <div id="zombieChar">üßü</div>
</div>
<div id="zhp">30/30</div>
<div class="bar"><div id="zbar" style="width:100%;background:green"></div></div>
</div>

<!-- MAIN ACTION ROW -->
<div class="main-action-row">
<button class="action-btn" onclick="openSkills()" style="background:#2196f3;">‚ú®</button>
<button id="axeAttackButton" class="action-btn button-click-protected" onclick="protectedAttack()" style="background:#ff5255;">ü™ì</button>
<button class="action-btn" onclick="openSkins()" style="background:#9c27b0;">üé®</button>
</div>

<div id="energyWarning" style="color:#ff5252;font-size:12px;margin-top:5px;display:none;">‚ö° Not enough energy</div>
</div>

<!-- UPDATED LEFT SIDE MENU (6 ICONS) -->
<div class="side-menu left">
<div class="side-btn" onclick="protectedWatchAd()">üì∫</div>
<div class="side-btn" onclick="openDailyReward()">üéÅ</div>
<div class="side-btn" onclick="openSpinWheel()">üé°</div>
<div class="side-btn" onclick="openReferral()">üë•</div>
<div class="side-btn" onclick="openLeaderboard()">üèÜ</div>
<div class="side-btn" onclick="openAchievements()">üèÖ</div>
</div>

<!-- UPDATED RIGHT SIDE MENU (6 ICONS) -->
<div class="side-menu right">
<div class="side-btn" onclick="openSettings()">‚öôÔ∏è</div>
<div class="side-btn" onclick="openBossRaid()">üëπ</div>
<div class="side-btn" onclick="openStats()">üìä</div>
<div class="side-btn" onclick="openVIP()">‚≠ê</div>
<div class="side-btn" onclick="openConvertGems()">üîÅ</div>
<div class="side-btn" onclick="openSeasonPass()">üé´</div>
</div>

<!-- UPDATED BOTTOM MENU (3 ICONS ONLY) -->
<div class="bottom-menu">
<div class="bottom-btn" onclick="openWeapons()">‚öîÔ∏è Weapons</div>
<div class="bottom-btn" onclick="openCharacters()">üßô Characters</div>
<div class="bottom-btn" onclick="openShop()">üõí Shop</div>
</div>

<!-- ‚ú® NEW: PROFILE MODAL -->
<div id="profileModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üë§ Profile</h2>
<button class="close-btn" onclick="closeModal('profileModal')">‚úï</button>
</div>
<div id="profileContent">
<div class="profile-header">
<div class="profile-avatar" id="profileAvatar">ü¶∏‚Äç‚ôÇÔ∏è</div>
<div class="profile-name" id="profilePlayerName">Player</div>
<div class="profile-level">‚≠ê Level <span id="profileLevel">1</span></div>
</div>
<div id="profileStats"></div>
</div>
</div>
</div>

<!-- ‚ú® NEW: SHOP MODAL -->
<div id="shopModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üõí Shop</h2>
<button class="close-btn" onclick="closeModal('shopModal')">‚úï</button>
</div>
<div class="shop-tabs" id="shopTabs">
<div class="shop-tab active" onclick="switchShopTab('items')">Items</div>
<div class="shop-tab" onclick="switchShopTab('skins')">Skins</div>
</div>
<div id="shopItemsContent"></div>
<div id="shopSkinsContent" style="display:none;"></div>
</div>
</div>

<!-- ‚ú® NEW: SKINS MODAL -->
<div id="skinsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üé® Skins</h2>
<button class="close-btn" onclick="closeModal('skinsModal')">‚úï</button>
</div>
<div id="skinsContent">
<div class="skin-pack-grid" id="skinsList">
<!-- Skin packs will be loaded here -->
</div>
</div>
</div>
</div>

<!-- WEAPONS MODAL -->
<div id="weaponsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>‚öîÔ∏è Weapons</h2>
<button class="close-btn" onclick="closeModal('weaponsModal')">‚úï</button>
</div>
<div id="weaponsList" class="item-grid"></div>
</div>
</div>

<!-- CHARACTERS MODAL -->
<div id="charactersModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üßô Characters</h2>
<button class="close-btn" onclick="closeModal('charactersModal')">‚úï</button>
</div>
<div id="charactersList" class="item-grid"></div>
</div>
</div>

<!-- SKILLS MODAL -->
<div id="skillsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>‚ú® Skills & Upgrades</h2>
<button class="close-btn" onclick="closeModal('skillsModal')">‚úï</button>
</div>
<div id="skillsList"></div>
</div>
</div>

<!-- ‚ú® NEW: VIP MODAL -->
<div id="vipModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>‚≠ê VIP Upgrade</h2>
<button class="close-btn" onclick="closeModal('vipModal')">‚úï</button>
</div>
<div id="vipList"></div>
<div style="margin-top:20px;padding:10px;background:rgba(255,215,0,0.1);border-radius:8px;">
<p style="font-size:12px;color:#aaa;">üí° VIP Bonus applies to: Kills, Ads, Daily Rewards</p>
<p style="font-size:12px;color:#aaa;">Current VIP Tier: <span id="currentVIPTier" style="color:#ffc107;font-weight:bold;">No VIP</span></p>
<p style="font-size:12px;color:#aaa;">Current VIP Bonus: <span id="currentVIPBonus">0%</span></p>
</div>
</div>
</div>

<!-- ‚ú® NEW: INVENTORY MODAL -->
<div id="inventoryModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üéí Inventory</h2>
<button class="close-btn" onclick="closeModal('inventoryModal')">‚úï</button>
</div>
<div id="inventoryList">
<div style="text-align:center;padding:10px;">
<h3 style="color:#ffc107;">Your Inventory</h3>
</div>
</div>
</div>
</div>

<!-- ‚ú® NEW: ACHIEVEMENTS MODAL -->
<div id="achievementsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üèÖ Achievements</h2>
<button class="close-btn" onclick="closeModal('achievementsModal')">‚úï</button>
</div>
<div id="achievementsList"></div>
</div>
</div>

<!-- ‚ú® FIXED: DAILY REWARD MODAL -->
<div id="dailyRewardModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üéÅ Daily Reward</h2>
<button class="close-btn" onclick="closeModal('dailyRewardModal')">‚úï</button>
</div>
<div style="padding:15px;text-align:center;">
<div style="font-size:48px;margin:20px 0;">üéÅ</div>
<h3>Daily Bonus!</h3>
<p style="color:#aaa;margin-bottom:20px;">Claim your daily reward every 24 hours</p>
<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:20px;">
<p style="font-size:16px;margin:5px 0;">üéØ Reward: <span style="color:#ffc107;font-weight:bold;">50 Coins + 0.005 TON</span></p>
<p style="font-size:14px;color:#4caf50;">VIP Bonus Applied: +<span id="dailyVIPBonus">0</span>%</p>
</div>
<div id="dailyTimer" style="font-size:18px;color:#4caf50;font-weight:bold;margin:15px 0;">00:00:00</div>
<button id="dailyClaimButton" onclick="protectedClaimDailyReward()" class="button-click-protected" style="width:100%;padding:12px;font-size:16px;margin-top:10px;" disabled>
‚è≥ Claim in 00:00:00
</button>
</div>
</div>
</div>

<!-- STATS MODAL -->
<div id="statsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üìä Statistics</h2>
<button class="close-btn" onclick="closeModal('statsModal')">‚úï</button>
</div>
<div id="statsList"></div>
</div>
</div>

<!-- ‚ú® FIXED: SETTINGS MODAL WITH MUSIC TOGGLE -->
<div id="settingsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>‚öôÔ∏è Settings</h2>
<button class="close-btn" onclick="closeModal('settingsModal')">‚úï</button>
</div>
<div id="settingsList"></div>
</div>
</div>

<!-- REFERRAL MODAL -->
<div id="referralModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üë• Referrals</h2>
<button class="close-btn" onclick="closeModal('referralModal')">‚úï</button>
</div>
<div id="referralContent"></div>
</div>
</div>

<!-- ‚ú® FIXED: SPIN WHEEL MODAL - 6 SLOTS -->
<div id="spinModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üé° Spin the Wheel</h2>
<button class="close-btn" onclick="closeModal('spinModal')">‚úï</button>
</div>
<div class="wheel-container">
<div class="wheel-pointer"></div>
<div class="wheel" id="wheel"></div>
<div class="wheel-center">
<img id="wheelCenterImage" src="https://api.dicebear.com/7.x/adventurer/svg?seed=ninja&backgroundColor=1a1a2e" alt="Ninja">
</div>
</div>
<div class="spin-result" id="spinResult"></div>
<div class="spin-timer" id="spinTimer">üîí Next spin in: 00:00:00</div>
<button id="spinButton" onclick="protectedSpinWheel()" class="button-click-protected" style="width:100%;padding:12px;margin-top:10px" disabled>
üîí SPIN (Cooldown)
</button>
</div>
</div>

<!-- ‚ú® NEW: WALLET MODAL -->
<div id="walletModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üí∞ Wallet</h2>
<button class="close-btn" onclick="closeModal('walletModal')">‚úï</button>
</div>
<div style="padding:15px;">
<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:8px;margin-bottom:20px;">
<h3 style="margin-top:0;color:#ffc107;">TON Balance</h3>
<p style="font-size:32px;font-weight:bold;text-align:center;margin:10px 0;">0.000</p>
<p style="font-size:12px;color:#aaa;text-align:center;">‚âà $0.00</p>
</div>
<div style="margin-bottom:15px;">
<label style="display:block;margin-bottom:5px;color:#aaa;">Connected Address:</label>
<div style="background:#0f0f1e;padding:10px;border-radius:8px;border:1px solid #444;font-size:12px;word-break:break-all;">
Not connected
</div>
</div>
<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:8px;margin-bottom:20px;">
<h4 style="margin-top:0;color:#4caf50;">Withdrawal Rules</h4>
<p style="font-size:14px;color:#aaa;margin:5px 0;">‚Ä¢ Minimum: <strong>20 TON</strong></p>
<p style="font-size:14px;color:#aaa;margin:5px 0;">‚Ä¢ Fee: <strong>25%</strong></p>
<p style="font-size:14px;color:#aaa;margin:5px 0;">‚Ä¢ Processing Time: 24-48 hours</p>
</div>
<button onclick="openWithdrawal()" style="width:100%;padding:12px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-weight:bold;">
üí∏ Withdraw TON
</button>
</div>
</div>
</div>

<!-- ‚ú® NEW: WITHDRAWAL MODAL -->
<div id="withdrawalModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üí∞ Withdraw TON</h2>
<button class="close-btn" onclick="closeModal('withdrawalModal')">‚úï</button>
</div>
<div style="padding:15px;">
<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:8px;margin-bottom:15px;">
<h3 style="margin-top:0;color:#ffc107;">Withdrawal Rules</h3>
<p style="font-size:14px;color:#aaa;">‚Ä¢ Minimum: <strong>20 TON</strong></p>
<p style="font-size:14px;color:#aaa;">‚Ä¢ Fee: <strong>25%</strong></p>
<p style="font-size:14px;color:#aaa;">‚Ä¢ Network: TON Blockchain</p>
<p style="font-size:14px;color:#aaa;">‚Ä¢ Processing Time: 24-48 hours</p>
</div>
<div style="margin-bottom:15px;">
<label style="display:block;margin-bottom:5px;">Amount to Withdraw (TON):</label>
<input type="number" id="withdrawAmount" min="20" step="1" value="20" style="width:100%;padding:10px;border-radius:8px;background:#0f0f1e;border:1px solid #444;color:#fff;">
</div>
<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:8px;margin-bottom:15px;">
<h4 style="margin-top:0;color:#4caf50;">Summary</h4>
<p style="font-size:14px;">Requested: <span id="requestedAmount">20</span> TON</p>
<p style="font-size:14px;">Fee (25%): <span id="feeAmount">5</span> TON</p>
<p style="font-size:16px;font-weight:bold;color:#ffc107;">You receive: <span id="finalAmount">15</span> TON</p>
</div>
<button onclick="processWithdrawal()" style="width:100%;padding:12px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-weight:bold;">
üí∏ Request Withdrawal
</button>
</div>
</div>
</div>

<!-- ‚ú® NEW: BOSS RAID MODAL -->
<div id="bossRaidModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üëπ Boss Raid</h2>
<button class="close-btn" onclick="closeModal('bossRaidModal')">‚úï</button>
</div>
<div style="padding:15px;text-align:center;">
<div style="font-size:72px;margin:20px 0;">üëπ</div>
<h3>Giant Zombie King</h3>
<p style="color:#aaa;margin-bottom:20px;">Fight the boss with other players!</p>
<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:20px;">
<div style="display:flex;justify-content:space-between;margin-bottom:10px;">
<span>Boss HP:</span>
<span style="color:#ff5252;">5,000,000/5,000,000</span>
</div>
<div class="bar"><div style="width:100%;background:#ff5252"></div></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:20px 0;">
<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;">
<div style="font-size:12px;color:#aaa;">Participants</div>
<div style="font-size:20px;font-weight:bold;">128</div>
</div>
<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;">
<div style="font-size:12px;color:#aaa;">Time Left</div>
<div style="font-size:20px;font-weight:bold;color:#4caf50;">24:30:15</div>
</div>
</div>
<button onclick="joinBossRaid()" style="width:100%;padding:12px;background:#ff5252;color:#fff;border:none;border-radius:8px;font-weight:bold;font-size:16px;">
‚öîÔ∏è Join Raid
</button>
</div>
</div>
</div>

<!-- ‚ú® NEW: CONVERT GEMS MODAL -->
<div id="convertGemsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üîÅ Convert Gems ‚Üí TON</h2>
<button class="close-btn" onclick="closeModal('convertGemsModal')">‚úï</button>
</div>
<div style="padding:15px;text-align:center;">
<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:10px;margin-bottom:20px;">
<div style="font-size:14px;color:#aaa;">Conversion Rate</div>
<div style="font-size:28px;font-weight:bold;color:#ffc107;margin:10px 0;">
100 üíé = 0.1 TON
</div>
<div style="font-size:12px;color:#4caf50;">1 üíé = 0.001 TON</div>
</div>
<div style="margin-bottom:20px;">
<label style="display:block;margin-bottom:10px;color:#aaa;">Gems to Convert:</label>
<div style="display:flex;align-items:center;gap:10px;">
<button onclick="adjustGems(-100)" style="padding:10px 15px;background:#444;border-radius:8px;">-100</button>
<input type="number" id="gemsToConvert" value="100" min="100" step="100" style="flex:1;padding:10px;background:#0f0f1e;border:1px solid #444;border-radius:8px;color:#fff;text-align:center;">
<button onclick="adjustGems(100)" style="padding:10px 15px;background:#444;border-radius:8px;">+100</button>
</div>
<div style="margin-top:10px;font-size:12px;color:#aaa;">
Available Gems: <span style="color:#ffc107;font-weight:bold;" id="availableGems">0</span> üíé
</div>
</div>
<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:8px;margin-bottom:20px;">
<h4 style="margin-top:0;color:#4caf50;">Conversion Summary</h4>
<p>You convert: <span style="color:#ffc107;font-weight:bold;" id="convertGemsAmount">100</span> üíé</p>
<p>You receive: <span style="color:#4caf50;font-weight:bold;" id="receiveTONAmount">0.1</span> TON</p>
</div>
<button onclick="convertGemsToTON()" style="width:100%;padding:12px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-weight:bold;">
üíé Convert to TON
</button>
</div>
</div>
</div>

<!-- ‚ú® NEW: SEASON PASS MODAL -->
<div id="seasonPassModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üé´ Season Pass</h2>
<button class="close-btn" onclick="closeModal('seasonPassModal')">‚úï</button>
</div>
<div style="padding:15px;">
<div style="text-align:center;margin-bottom:20px;">
<div style="font-size:14px;color:#aaa;">Season 1 ‚Ä¢ Days Left: <span style="color:#4caf50;font-weight:bold;">28</span></div>
<div style="font-size:24px;font-weight:bold;color:#ffc107;">Zombie Apocalypse</div>
</div>
<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:8px;margin-bottom:20px;">
<div style="display:flex;justify-content:space-between;margin-bottom:10px;">
<span style="font-weight:bold;">Free Track</span>
<span style="color:#aaa;">Level 5/30</span>
</div>
<div class="bar"><div style="width:17%;background:#1e88e5"></div></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:8px;border:2px solid #1e88e5;">
<h4 style="margin-top:0;color:#1e88e5;">Free</h4>
<ul style="text-align:left;padding-left:20px;font-size:12px;color:#aaa;">
<li>100 Coins (Level 1)</li>
<li>Common Skin (Level 5)</li>
<li>500 Coins (Level 10)</li>
<li>Rare Weapon (Level 20)</li>
</ul>
</div>
<div style="background:rgba(255,193,7,0.1);padding:15px;border-radius:8px;border:2px solid #ffc107;">
<div style="position:absolute;top:-10px;right:10px;background:#ffc107;color:#000;padding:2px 8px;border-radius:5px;font-size:10px;font-weight:bold;">PREMIUM</div>
<h4 style="margin-top:0;color:#ffc107;">Premium Pass</h4>
<p style="font-size:24px;color:#ffc107;font-weight:bold;">2.5 TON</p>
<ul style="text-align:left;padding-left:20px;font-size:12px;color:#aaa;">
<li>All Free Rewards +</li>
<li>+100% XP Boost</li>
<li>Epic Character (Level 1)</li>
<li>Legendary Skin (Level 15)</li>
<li>5,000 Coins (Level 30)</li>
</ul>
</div>
</div>
<button onclick="buySeasonPass()" style="width:100%;padding:12px;background:linear-gradient(45deg, #ffc107, #ff9800);color:#000;border:none;border-radius:8px;font-weight:bold;">
üé´ Buy Premium Pass - 2.5 TON
</button>
</div>
</div>
</div>

<!-- ‚ú® NEW: LEADERBOARD MODAL -->
<div id="leaderboardModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>üèÜ Leaderboard</h2>
<button class="close-btn" onclick="closeModal('leaderboardModal')">‚úï</button>
</div>
<div style="padding:15px;">
<div style="display:flex;justify-content:space-around;margin-bottom:20px;border-bottom:1px solid #444;padding-bottom:10px;">
<button onclick="switchLeaderboardTab('weekly')" style="background:none;border:none;color:#fff;padding:8px 15px;border-radius:5px;" id="weeklyTab">Weekly</button>
<button onclick="switchLeaderboardTab('alltime')" style="background:none;border:none;color:#aaa;padding:8px 15px;border-radius:5px;" id="alltimeTab">All Time</button>
<button onclick="switchLeaderboardTab('referral')" style="background:none;border:none;color:#aaa;padding:8px 15px;border-radius:5px;" id="referralTab">Referrals</button>
</div>
<div id="leaderboardContent">
<!-- Content will be loaded here -->
</div>
</div>
</div>
</div>

<!-- CONFIRM DIALOG -->
<div id="confirmModal" class="modal">
<div class="confirm-dialog">
<h3>‚ö†Ô∏è Reset Game?</h3>
<p>This will delete all progress!</p>
<div class="buttons">
<button onclick="closeModal('confirmModal')">Cancel</button>
<button onclick="confirmReset()" style="background:#ff5252">Reset</button>
</div>
</div>
</div>

<div id="toast"></div>

<script>
// ‚ú® FIXED: Enhanced Sound System
let audioContext;
let isMusicEnabled = true;
let isSoundEnabled = true;
let isAttacking = false;

// Initialize Telegram WebApp
let tg = window.Telegram?.WebApp;
if(tg){
tg.ready();
tg.expand();
}

// Initialize sound system
function initSounds(){
try {
audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
// Enable audio context on first user interaction
document.addEventListener('click', function initAudio() {
if (audioContext && audioContext.state === 'suspended') {
audioContext.resume();
}
document.removeEventListener('click', initAudio);
}, { once: true });
        
} catch (e) {
console.log("Audio not supported:", e);
}
}

// Play UI click sound
function playClickSound() {
if (!isSoundEnabled || !audioContext) return;
    
try {
const now = audioContext.currentTime;
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();
        
oscillator.connect(gainNode);
gainNode.connect(audioContext.destination);
        
oscillator.frequency.setValueAtTime(800, now);
oscillator.frequency.exponentialRampToValueAtTime(400, now + 0.1);
        
gainNode.gain.setValueAtTime(0.1, now);
gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        
oscillator.start(now);
oscillator.stop(now + 0.1);
} catch (e) {
// Silent fail
}
}

// Play action sounds
function playSound(type){
if(!isSoundEnabled || !audioContext) return;

const now = audioContext.currentTime;
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();

oscillator.connect(gainNode);
gainNode.connect(audioContext.destination);

switch(type){
case 'attack':
oscillator.frequency.setValueAtTime(300, now);
gainNode.gain.setValueAtTime(0.1, now);
gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
oscillator.start(now);
oscillator.stop(now + 0.1);
break;
case 'hit':
oscillator.frequency.setValueAtTime(150, now);
gainNode.gain.setValueAtTime(0.15, now);
gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
oscillator.start(now);
oscillator.stop(now + 0.15);
break;
case 'death':
oscillator.frequency.setValueAtTime(100, now);
oscillator.frequency.exponentialRampToValueAtTime(50, now + 0.3);
gainNode.gain.setValueAtTime(0.2, now);
gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
oscillator.start(now);
oscillator.stop(now + 0.3);
break;
case 'coin':
oscillator.frequency.setValueAtTime(800, now);
oscillator.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
gainNode.gain.setValueAtTime(0.08, now);
gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
oscillator.start(now);
oscillator.stop(now + 0.1);
break;
case 'levelup':
oscillator.frequency.setValueAtTime(400, now);
oscillator.frequency.exponentialRampToValueAtTime(800, now + 0.1);
gainNode.gain.setValueAtTime(0.1, now);
gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
oscillator.start(now);
oscillator.stop(now + 0.1);
            
// Second tone
setTimeout(() => {
if (!isSoundEnabled || !audioContext) return;
const osc2 = audioContext.createOscillator();
const gain2 = audioContext.createGain();
osc2.connect(gain2);
gain2.connect(audioContext.destination);
                
const now2 = audioContext.currentTime;
osc2.frequency.setValueAtTime(800, now2);
osc2.frequency.exponentialRampToValueAtTime(1200, now2 + 0.1);
gain2.gain.setValueAtTime(0.1, now2);
gain2.gain.exponentialRampToValueAtTime(0.01, now2 + 0.1);
osc2.start(now2);
osc2.stop(now2 + 0.1);
}, 100);
break;
case 'spin':
oscillator.frequency.setValueAtTime(400, now);
oscillator.frequency.exponentialRampToValueAtTime(200, now + 0.05);
gainNode.gain.setValueAtTime(0.1, now);
gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
oscillator.start(now);
oscillator.stop(now + 0.05);
break;
}
}

// Toggle music
function toggleMusic() {
isMusicEnabled = !isMusicEnabled;
const musicToggle = document.getElementById('musicToggle');
if (musicToggle) {
musicToggle.checked = isMusicEnabled;
}
    
if (isMusicEnabled) {
if (audioContext && audioContext.state === 'suspended') {
audioContext.resume();
}
toastMsg("üéµ Music ON");
} else {
toastMsg("üîá Music OFF");
}
saveGame();
}

// Toggle sound
function toggleSound() {
isSoundEnabled = !isSoundEnabled;
player.soundEnabled = isSoundEnabled;
update();
toastMsg(isSoundEnabled ? "üîä Sound ON" : "üîá Sound OFF");
saveGame();
}

// Add click sounds to all buttons
function setupButtonSounds() {
const buttons = document.querySelectorAll('button, .side-btn, .bottom-btn, .action-btn');
buttons.forEach(button => {
const originalOnClick = button.onclick;
if (originalOnClick) {
button.onclick = function(e) {
playClickSound();
return originalOnClick.call(this, e);
};
} else {
button.addEventListener('click', playClickSound);
}
});
    
// Add to modal close buttons
const closeButtons = document.querySelectorAll('.close-btn');
closeButtons.forEach(btn => {
btn.addEventListener('click', playClickSound);
});
}

// ‚ú® FIXED: Game State with all improvements
let player = {
hp: 100,
max: 100,
baseMax: 100,
hpUpgrades: 0,
coins: 0,
gems: 0,
level: 1,
xp: 0,
xpMax: 100,
energy: 100,
energyMax: 100,
weapon: "sword",
char: "hero",
name: "Player",
kills: 0,
coinsEarned: 0,
referrals: 0,
referralCode: "",
ownedWeapons: ["sword"],
ownedChars: ["hero"],
soundEnabled: true,
vipTier: 0,
vipBonus: 0,
lastSpinTime: 0,
spinCount: 0,
lastDailyTime: 0,
dailyCount: 0,
achievements: {
kill100: {completed: false, claimed: false, progress: 0, target: 100},
level10: {completed: false, claimed: false, progress: 0, target: 10},
spin5: {completed: false, claimed: false, progress: 0, target: 5},
daily7: {completed: false, claimed: false, progress: 0, target: 7}
},
ownedSkins: ["common"],
activeSkin: null,
skins: {}
};

let zombie = {hp: 30, max: 30};

// ‚ú® FIXED: Spin wheel prizes (6 slots)
const wheelPrizes = [
{text: "500", value: 500, type: "coins"},
{text: "1000", value: 1000, type: "coins"},
{text: "2000", value: 2000, type: "coins"},
{text: "0.005", value: 0.005, type: "ton"},
{text: "0.01", value: 0.01, type: "ton"},
{text: "SORRY", value: 0, type: "none"}
];
const wheelColors = ['#ffc107', '#4caf50', '#2196f3', '#9c27b0', '#ff9800', '#f44336'];

// Skin packs data
const skinPacks = [
{id: "common", name: "Starter Pack", price: 0, priceType: "free", icon: "üéÅ", desc: "Free basic skins", rarity: "common", skins: ["hero_basic"]},
{id: "rare", name: "Ninja Pack", price: 0.2, priceType: "ton", icon: "ü•∑", desc: "Ninja-themed skins", rarity: "rare", skins: ["ninja_dark", "hero_ninja"]},
{id: "epic", name: "Dark Pack", price: 0.5, priceType: "ton", icon: "üåë", desc: "Dark-themed skins", rarity: "epic", skins: ["hero_dark", "slayer_dark"]},
{id: "legendary", name: "Neon Pack", price: 1, priceType: "ton", icon: "üí°", desc: "Neon glow skins", rarity: "legendary", skins: ["hero_neon", "wizard_neon", "knight_neon"]}
];

// Character skins data
const characterSkins = {
hero: [
{id: "default", name: "Default", icon: "ü¶∏‚Äç‚ôÇÔ∏è", pack: "common"},
{id: "hero_basic", name: "Basic", icon: "ü¶∏‚Äç‚ôÇÔ∏è", color: "#1e88e5", pack: "common"},
{id: "hero_ninja", name: "Ninja Style", icon: "ü•∑", color: "#333", pack: "rare"},
{id: "hero_dark", name: "Dark Knight", icon: "ü¶á", color: "#222", pack: "epic"},
{id: "hero_neon", name: "Neon Hero", icon: "ü¶∏‚Äç‚ôÇÔ∏è", color: "#00ff88", pack: "legendary"}
],
ninja: [
{id: "default", name: "Default", image: "https://api.dicebear.com/7.x/adventurer/svg?seed=ninja&backgroundColor=1a1a2e", pack: "common"},
{id: "ninja_dark", name: "Shadow Ninja", image: "https://api.dicebear.com/7.x/adventurer/svg?seed=shadow&backgroundColor=1a1a2e&hair=short&hairColor=000000", pack: "rare"}
],
slayer: [
{id: "default", name: "Default", icon: "üßî‚Äç‚ôÇÔ∏è", pack: "common"},
{id: "slayer_dark", name: "Dark Slayer", icon: "üßõ‚Äç‚ôÇÔ∏è", color: "#660000", pack: "epic"}
],
wizard: [
{id: "default", name: "Default", icon: "üßô‚Äç‚ôÇÔ∏è", pack: "common"},
{id: "wizard_neon", name: "Neon Wizard", icon: "üßô‚Äç‚ôÇÔ∏è", color: "#ff00ff", pack: "legendary"}
],
knight: [
{id: "default", name: "Default", icon: "üõ°Ô∏è", pack: "common"},
{id: "knight_neon", name: "Neon Knight", icon: "üõ°Ô∏è", color: "#00ffff", pack: "legendary"}
]
};

let isSpinning = false;

// Timer variables
let spinTimerInterval = null;
let dailyTimerInterval = null;

// Button click protection
let buttonCooldowns = {};
let attackCooldown = false;

// Skills State
let skills = {
damage: {level: 0, max: 5},
hp: {level: 0, max: 5},
crit: {level: 0, max: 3}
};

// Weapons Data
let weapons = {
sword: {name: "Basic Sword", dmg: 10, price: 0, icon: "‚öîÔ∏è", desc: "Starter weapon"},
axe: {name: "Battle Axe", dmg: 20, price: 100, icon: "ü™ì", desc: "+10 damage"},
gun: {name: "Power Gun", dmg: 35, price: 300, icon: "üî´", desc: "+25 damage"},
laser: {name: "Laser Sword", dmg: 50, price: 600, icon: "üó°Ô∏è", desc: "+40 damage"},
hammer: {name: "Thunder Hammer", dmg: 75, price: 1000, icon: "üî®", desc: "+65 damage"}
};

// Characters Data with Ninja image
let characters = {
hero: {name: "Hero", icon: "ü¶∏‚Äç‚ôÇÔ∏è", hp: 100, level: 1, price: 0, desc: "Balanced fighter"},
ninja: {name: "Ninja", icon: "ü•∑", image: "https://api.dicebear.com/7.x/adventurer/svg?seed=ninja&backgroundColor=1a1a2e", hp: 80, level: 5, price: 200, desc: "Fast attacks"},
slayer: {name: "Slayer", icon: "üßî‚Äç‚ôÇÔ∏è", hp: 150, level: 10, price: 500, desc: "High HP tank"},
wizard: {name: "Wizard", icon: "üßô‚Äç‚ôÇÔ∏è", hp: 90, level: 15, price: 800, desc: "Magic damage"},
knight: {name: "Knight", icon: "üõ°Ô∏è", hp: 200, level: 20, price: 1200, desc: "Ultimate defense"}
};

// VIP Tiers Data
const vipTiers = [
{id: 0, name: "No VIP", bonus: 0, price: 0, desc: "Standard earnings"},
{id: 1, name: "VIP 1", bonus: 10, price: 0.5, desc: "+10% coin earnings"},
{id: 2, name: "VIP 2", bonus: 25, price: 2.5, desc: "+25% coin earnings"},
{id: 3, name: "VIP 3", bonus: 50, price: 10, desc: "+50% coin earnings"},
{id: 4, name: "VIP 4", bonus: 100, price: 50, desc: "+100% coin earnings"}
];

// Energy regeneration timer
let energyTimer = null;

// ‚ú® FIXED: Attack function with single tap response
function attack(){
if(isAttacking) return;
if(attackCooldown) return;
    
if(player.hp <= 0){
toastMsg("‚ùå You are dead! Heal first!");
return;
}

// Check energy
if (player.energy < 5) {
toastMsg("‚ö° Not enough energy! Wait for regeneration.");
return;
}

// Set cooldown
isAttacking = true;
attackCooldown = true;

// Visual feedback
const attackButton = document.getElementById('axeAttackButton');
attackButton.classList.add('button-press');
attackButton.classList.add('glow');

setTimeout(() => {
attackButton.classList.remove('button-press');
attackButton.classList.remove('glow');
}, 200);

setTimeout(() => {
isAttacking = false;
attackCooldown = false;
}, 300);

// Consume energy
player.energy -= 5;
updateEnergyUI();

playerChar.classList.add("attack");
zombieChar.classList.add("hit");
playSound('attack');

// Calculate damage
let dmg = weapons[player.weapon].dmg;
dmg += skills.damage.level * 5;

// Critical hit chance
let isCrit = Math.random() < (skills.crit.level * 0.1);
if(isCrit){
dmg *= 2;
floatText("üí• CRIT -" + dmg, zombieChar);
playSound('hit');
// Screen shake on crit
gameContainer.classList.add('shake');
setTimeout(() => gameContainer.classList.remove('shake'), 300);
} else {
floatText("-" + dmg, zombieChar);
playSound('hit');
}

zombie.hp -= dmg;

if(zombie.hp <= 0){
player.kills++;

// XP-based leveling system
let xpGain = 20 + Math.floor(player.level * 2);
player.xp += xpGain;
  
// Coin reward scaling
let coinGain = 10 + Math.floor(player.level / 2);
coinGain = applyVIPBonus(coinGain);
  
player.coins += coinGain;
player.coinsEarned += coinGain;
playSound('coin');

// Check for level up
if(player.xp >= player.xpMax){
player.xp -= player.xpMax;
player.level++;
player.xpMax = Math.floor(100 + (player.level * 15));
playSound('levelup');
toastMsg("üéâ LEVEL UP! Level " + player.level);
// Level up visual effect
gameContainer.classList.add('levelup');
setTimeout(() => gameContainer.classList.remove('levelup'), 800);
} else {
toastMsg(`+${xpGain}‚ö° +${coinGain}üí∞`);
}

playSound('death');
// Zombie HP scaling
zombie.max = 30 + (player.level * 2);
zombie.hp = zombie.max;
}

// Zombie counter attack
setTimeout(() => {
let zombieDmg = 5 + Math.floor(player.level / 3);
player.hp = Math.max(0, player.hp - zombieDmg);
if(player.hp > 0){
floatText("-" + zombieDmg, playerChar);
}
if(player.hp === 0){
toastMsg("üíÄ You died! Watching ad to revive...");
setTimeout(() => {
player.hp = player.max;
update();
toastMsg("‚úÖ Revived!");
}, 2000);
}
update();
}, 400);

setTimeout(() => {
playerChar.classList.remove("attack");
zombieChar.classList.remove("hit");
}, 200);

update();
}

// Protected attack function
function protectedAttack() {
if (buttonCooldowns['attack']) return;
  
buttonCooldowns['attack'] = true;
attack();
  
setTimeout(() => {
buttonCooldowns['attack'] = false;
}, 300);
}

// Load saved data
function loadGame(){
let saved = localStorage.getItem("zombieFighterSave");
if(saved){
let data = JSON.parse(saved);
Object.assign(player, data.player);
Object.assign(skills, data.skills);
// Ensure new properties exist
if(!player.xp) player.xp = 0;
if(!player.xpMax) player.xpMax = 100;
if(!player.baseMax) player.baseMax = 100;
if(!player.hpUpgrades) player.hpUpgrades = 0;
if(!player.energy) player.energy = 100;
if(!player.energyMax) player.energyMax = 100;
if(!player.vipTier) player.vipTier = 0;
if(!player.vipBonus) player.vipBonus = 0;
if(!player.lastSpinTime) player.lastSpinTime = 0;
if(!player.spinCount) player.spinCount = 0;
if(!player.lastDailyTime) player.lastDailyTime = 0;
if(!player.dailyCount) player.dailyCount = 0;
if(!player.achievements) {
player.achievements = {
kill100: {completed: false, claimed: false, progress: 0, target: 100},
level10: {completed: false, claimed: false, progress: 0, target: 10},
spin5: {completed: false, claimed: false, progress: 0, target: 5},
daily7: {completed: false, claimed: false, progress: 0, target: 7}
};
}
// Load skins data
if(!player.ownedSkins) player.ownedSkins = ["common"];
if(!player.activeSkin) player.activeSkin = null;
if(!player.skins) player.skins = {};
}
// Get Telegram username
if(tg && tg.initDataUnsafe?.user){
player.name = tg.initDataUnsafe.user.first_name || "Player";
}
// Generate referral code if not exists
if(!player.referralCode){
player.referralCode = "ZF" + Math.random().toString(36).substr(2, 6).toUpperCase();
}

// Set sound states
isSoundEnabled = player.soundEnabled;

// Start energy regeneration
startEnergyRegeneration();

// Start timers
startTimers();

// Update VIP bonus
updateVIPBonus();

// Update achievement progress
updateAchievementProgress();

update();
}

// Save game
function saveGame(){
localStorage.setItem("zombieFighterSave", JSON.stringify({
player: player,
skills: skills
}));
}

// Energy regeneration system
function startEnergyRegeneration() {
if (energyTimer) clearInterval(energyTimer);
energyTimer = setInterval(() => {
if (player.energy < player.energyMax) {
player.energy += 1;
updateEnergyUI();
saveGame();
}
}, 5000);
}

// Update energy UI
function updateEnergyUI() {
const energyElement = document.getElementById('energy');
const energyMaxElement = document.getElementById('energymax');
const energyBar = document.getElementById('energybar');
const energyWarning = document.getElementById('energyWarning');
  
energyElement.textContent = player.energy;
energyMaxElement.textContent = player.energyMax;
energyBar.style.width = (player.energy / player.energyMax * 100) + "%";
  
// Add smooth animation when regenerating
if (player.energy < player.energyMax) {
energyBar.classList.add('energy-regen');
} else {
energyBar.classList.remove('energy-regen');
}
  
// Disable attack button if not enough energy
const attackButton = document.getElementById('axeAttackButton');
if (player.energy < 5) {
attackButton.disabled = true;
energyWarning.style.display = 'block';
} else {
attackButton.disabled = false;
energyWarning.style.display = 'none';
}
}

// Update VIP bonus
function updateVIPBonus() {
const vipTier = vipTiers.find(tier => tier.id === player.vipTier);
if (vipTier) {
player.vipBonus = vipTier.bonus;
}
const currentVIPBonusElement = document.getElementById('currentVIPBonus');
const currentVIPTierElement = document.getElementById('currentVIPTier');
if (currentVIPBonusElement) {
currentVIPBonusElement.textContent = player.vipBonus + "%";
}
if (currentVIPTierElement) {
currentVIPTierElement.textContent = vipTiers[player.vipTier].name;
}
}

// Apply VIP bonus to coin earnings
function applyVIPBonus(coins) {
if (player.vipBonus > 0) {
const bonusMultiplier = 1 + (player.vipBonus / 100);
return Math.floor(coins * bonusMultiplier);
}
return coins;
}

// Button click protection function
function protectButton(buttonId, callback, cooldown = 500) {
if (buttonCooldowns[buttonId]) return;
  
buttonCooldowns[buttonId] = true;
  
// Add visual feedback
const button = document.querySelector(`[onclick*="${buttonId}"]`) || document.getElementById(buttonId);
if (button) {
button.classList.add('button-press');
setTimeout(() => button.classList.remove('button-press'), 200);
}
  
// Execute callback
if (callback) callback();
  
// Re-enable after cooldown
setTimeout(() => {
buttonCooldowns[buttonId] = false;
}, cooldown);
}

// Protected watch ad function
function protectedWatchAd() {
protectButton('watchAdButton', watchAd, 500);
}

// Protected spin wheel function
function protectedSpinWheel() {
protectButton('spinButton', spinWheel, 500);
}

// Protected claim daily reward function
function protectedClaimDailyReward() {
protectButton('dailyClaimButton', claimDailyReward, 500);
}

// Update UI
function update(){
hp.textContent = player.hp;
hpmax.textContent = player.max;
hpbar.style.width = (player.hp / player.max * 100) + "%";

// XP bar update
xp.textContent = player.xp;
xpmax.textContent = player.xpMax;
xpbar.style.width = (player.xp / player.xpMax * 100) + "%";

// Energy bar update
updateEnergyUI();

// Low HP warning
if(player.hp < player.max * 0.25){
hpLabel.classList.add('hp-low');
} else {
hpLabel.classList.remove('hp-low');
}

zhp.textContent = zombie.hp + "/" + zombie.max;
zbar.style.width = (zombie.hp / zombie.max * 100) + "%";
  
// Display character with active skin
updateCharacterDisplay();
  
coins.textContent = player.coins;
gems.textContent = player.gems;
level.textContent = player.level;
playerName.textContent = player.name;
  
// Update achievement progress
updateAchievementProgress();
  
saveGame();
}

// Update character display with skin
function updateCharacterDisplay() {
const charData = characters[player.char];
let displayHTML = '';
  
// Check if character has skins and active skin
if (player.skins && player.skins[player.char]) {
const skinId = player.skins[player.char];
const characterSkinList = characterSkins[player.char];
if (characterSkinList) {
const activeSkin = characterSkinList.find(skin => skin.id === skinId);
if (activeSkin) {
if (activeSkin.image) {
displayHTML = `<img src="${activeSkin.image}" alt="${charData.name}" class="ninja-icon" style="width:60px;height:60px;">`;
} else {
displayHTML = `<div style="font-size:48px;color:${activeSkin.color || 'inherit'}">${activeSkin.icon}</div>`;
}
} else {
// Fallback to default
if (player.char === 'ninja' && charData.image) {
displayHTML = `<img src="${charData.image}" alt="${charData.name}" class="ninja-icon" style="width:60px;height:60px;">`;
} else {
displayHTML = charData.icon;
}
}
}
} else {
// Default display
if (player.char === 'ninja' && charData.image) {
displayHTML = `<img src="${charData.image}" alt="${charData.name}" class="ninja-icon" style="width:60px;height:60px;">`;
} else {
displayHTML = charData.icon;
}
}
  
playerChar.innerHTML = displayHTML;
}

// Floating Damage Text
function floatText(text, el){
let d = document.createElement("div");
d.className = "float";
d.textContent = text;
d.style.left = (Math.random() * 30 + 35) + "%";
d.style.top = "50%";
el.parentElement.style.position = "relative";
el.parentElement.appendChild(d);
setTimeout(() => d.remove(), 1000);
}

// Toast Notification
function toastMsg(t){
toast.textContent = t;
toast.classList.add("show");
setTimeout(() => toast.classList.remove("show"), 2000);
}

// ‚ú® FIXED: Open Daily Reward modal
function openDailyReward() {
const modal = document.getElementById('dailyRewardModal');
const dailyVIPBonusElement = document.getElementById('dailyVIPBonus');
if (dailyVIPBonusElement) {
dailyVIPBonusElement.textContent = player.vipBonus;
}
    
// Clear any existing interval
if (dailyTimerInterval) {
clearInterval(dailyTimerInterval);
}
    
updateDailyTimer();
    
// Update immediately and then every second
dailyTimerInterval = setInterval(updateDailyTimer, 1000);
    
modal.classList.add('show');
}

// Update daily timer
function updateDailyTimer() {
const now = Date.now();
const lastDaily = player.lastDailyTime || 0;
const cooldown = 24 * 60 * 60 * 1000;
const timeLeft = cooldown - (now - lastDaily);
  
const dailyTimerElement = document.getElementById('dailyTimer');
const dailyClaimButton = document.getElementById('dailyClaimButton');
  
if (timeLeft > 0) {
// Still in cooldown
dailyTimerElement.textContent = formatTime(timeLeft);
dailyClaimButton.disabled = true;
dailyClaimButton.textContent = `‚è≥ Claim in ${formatTime(timeLeft)}`;
dailyTimerElement.classList.remove('reward-claimed');
} else {
// Ready to claim
dailyTimerElement.textContent = "üéÅ Ready to claim!";
dailyClaimButton.disabled = false;
dailyClaimButton.textContent = "üéÅ Claim Daily Reward";
dailyTimerElement.classList.add('reward-claimed');
}
}

// ‚ú® FIXED: Claim daily reward
function claimDailyReward() {
const now = Date.now();
const lastDaily = player.lastDailyTime || 0;
const cooldown = 24 * 60 * 60 * 1000;
    
// Prevent multiple clicks
const claimButton = document.getElementById('dailyClaimButton');
if (claimButton.disabled) return;
    
if (now - lastDaily < cooldown) {
const timeLeft = formatTime(cooldown - (now - lastDaily));
toastMsg(`‚è≥ Please wait ${timeLeft}`);
return;
}
    
// Disable button immediately
claimButton.disabled = true;
claimButton.textContent = "‚úÖ Claiming...";
    
// Give reward
let coins = 50;
let ton = 0.005;
    
coins = applyVIPBonus(coins);
    
player.coins += coins;
player.coinsEarned += coins;
player.lastDailyTime = Date.now();
player.dailyCount = (player.dailyCount || 0) + 1;
    
// Update achievements
updateAchievementProgress();
saveGame();
update();
    
// Visual feedback
const dailyTimerElement = document.getElementById('dailyTimer');
dailyTimerElement.classList.add('reward-claimed');
    
toastMsg(`üéÅ Daily reward claimed! +${coins} coins${player.vipBonus > 0 ? ` (VIP +${player.vipBonus}%)` : ''}`);
    
// Update button state
setTimeout(() => {
updateDailyTimer();
claimButton.disabled = false;
}, 2000);
}

// ‚ú® FIXED: Open Spin Wheel modal with 6 slots
function openSpinWheel() {
const modal = document.getElementById('spinModal');
const wheel = document.getElementById('wheel');
const spinResult = document.getElementById('spinResult');
    
// Clear previous
wheel.innerHTML = "";
spinResult.textContent = "";
    
// Create 6 wheel slices (60 degrees each)
for(let i = 0; i < 6; i++) {
let slice = document.createElement("div");
slice.className = "wheel-slice";
slice.style.transform = `rotate(${i * 60}deg)`;
slice.style.backgroundColor = wheelColors[i];
        
// Larger text for better readability
slice.innerHTML = `<div style="transform:rotate(30deg) translate(40px, 0);font-size:22px;font-weight:bold;color:#000;text-align:center;width:100px;">${wheelPrizes[i].text}</div>`;
wheel.appendChild(slice);
}
    
// Reset wheel rotation
wheel.style.transform = 'rotate(0deg)';
    
// Update timer
updateSpinTimer();
    
modal.classList.add('show');
}

// Update spin timer
function updateSpinTimer() {
const now = Date.now();
const lastSpin = player.lastSpinTime || 0;
const cooldown = 24 * 60 * 60 * 1000;
const timeLeft = cooldown - (now - lastSpin);
  
const spinButton = document.getElementById('spinButton');
const spinTimerElement = document.getElementById('spinTimer');
  
if (timeLeft > 0) {
// Still in cooldown
spinButton.disabled = true;
spinButton.innerHTML = 'üîí SPIN (Cooldown)';
spinTimerElement.textContent = `üîí Next spin in: ${formatTime(timeLeft)}`;
spinTimerElement.className = 'spin-timer locked';
} else {
// Ready to spin
spinButton.disabled = false;
spinButton.innerHTML = 'üé∞ SPIN (Free)';
spinTimerElement.textContent = '‚úÖ Ready to spin!';
spinTimerElement.className = 'spin-timer active';
}
}

// ‚ú® FIXED: Spin wheel function with smooth animation
function spinWheel(){
if(isSpinning) return;
    
const now = Date.now();
const lastSpin = player.lastSpinTime || 0;
const cooldown = 24 * 60 * 60 * 1000;
    
if (now - lastSpin < cooldown) {
toastMsg("‚è≥ You can spin again in " + formatTime(cooldown - (now - lastSpin)));
return;
}

isSpinning = true;
    
const wheel = document.getElementById('wheel');
const spinButton = document.getElementById('spinButton');
const result = document.getElementById('spinResult');

spinButton.disabled = true;
spinButton.textContent = "üåÄ Spinning...";
result.textContent = "";
    
// Random prize selection
let prizeIndex = Math.floor(Math.random() * wheelPrizes.length);
let prize = wheelPrizes[prizeIndex];
    
// Calculate rotation (multiple full rotations + prize offset)
let rotations = 5;
let targetAngle = rotations * 360 + (360 - (prizeIndex * 60) - 30);
    
// Smooth animation
wheel.style.transition = 'transform 3s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
wheel.style.transform = `rotate(${targetAngle}deg)`;
    
// Play spin sound
playSound('spin');
    
setTimeout(() => {
// Play win sound if not "SORRY"
if (prize.type !== "none") {
playSound('coin');
}
        
// Give prize
if (prize.type === "coins") {
let finalPrize = prize.value;
if (prize.value > 0) {
finalPrize = applyVIPBonus(prize.value);
player.coins += finalPrize;
player.coinsEarned += finalPrize;
}
result.textContent = `üéâ You won ${finalPrize.toLocaleString()} coins!`;
result.style.color = '#ffc107';
result.style.fontSize = '24px';
} else if (prize.type === "ton") {
result.textContent = `üéâ You won ${prize.value} TON!`;
result.style.color = '#4caf50';
result.style.fontSize = '24px';
} else {
result.textContent = "üòÖ Better luck next time!";
result.style.color = '#aaa';
result.style.fontSize = '20px';
}

// Update player data
player.lastSpinTime = Date.now();
player.spinCount = (player.spinCount || 0) + 1;
updateAchievementProgress();
saveGame();
update();

isSpinning = false;
updateSpinTimer();
}, 3500);
}

// Format time function (HH:MM:SS)
function formatTime(ms) {
const totalSeconds = Math.floor(ms / 1000);
const hours = Math.floor(totalSeconds / 3600);
const minutes = Math.floor((totalSeconds % 3600) / 60);
const seconds = totalSeconds % 60;
  
return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Start all timers
function startTimers() {
// Clear existing intervals
if (spinTimerInterval) clearInterval(spinTimerInterval);
if (dailyTimerInterval) clearInterval(dailyTimerInterval);
  
// Update spin timer every second
spinTimerInterval = setInterval(updateSpinTimer, 1000);
  
// Update daily timer every second
dailyTimerInterval = setInterval(updateDailyTimer, 1000);
}

// Update achievement progress
function updateAchievementProgress() {
// Update progress
player.achievements.kill100.progress = player.kills;
player.achievements.level10.progress = player.level;
player.achievements.spin5.progress = player.spinCount;
player.achievements.daily7.progress = player.dailyCount;

// Check completion
player.achievements.kill100.completed = player.kills >= 100;
player.achievements.level10.completed = player.level >= 10;
player.achievements.spin5.completed = player.spinCount >= 5;
player.achievements.daily7.completed = player.dailyCount >= 7;
}

// ‚ú® FIXED: Settings modal with music toggle
function openSettings(){
const modal = document.getElementById('settingsModal');
const list = document.getElementById('settingsList');
list.innerHTML = "";

list.innerHTML = `
<div class="setting-item">
<label>
<span>üéµ Background Music</span>
<input type="checkbox" id="musicToggle" ${isMusicEnabled ? "checked" : ""} onchange="toggleMusic()">
</label>
</div>
<div class="setting-item">
<label>
<span>üîä Sound Effects</span>
<input type="checkbox" id="soundToggle" ${isSoundEnabled ? "checked" : ""} onchange="toggleSound()">
</label>
</div>
<div class="setting-item">
<label>
<span>üåô Dark / Light Mode</span>
<input type="checkbox" checked disabled>
</label>
<p style="font-size:12px;color:#aaa;margin:5px 0;">Light mode coming soon</p>
</div>
<div class="setting-item">
<label>
<span>üë§ Change Name</span>
</label>
<input type="text" id="playerNameInput" value="${player.name}" placeholder="Enter your name">
<button onclick="protectedChangeName()" class="button-click-protected" style="width:100%;margin-top:8px">Change Name</button>
</div>
<div class="setting-item">
<button onclick="openSeasonPass()" style="width:100%;padding:12px;background:linear-gradient(45deg, #ffc107, #ff9800);color:#000;border:none;border-radius:8px;font-weight:bold;margin-bottom:5px;">
üé´ Season Pass
</button>
</div>
<div class="setting-item">
<h4 style="margin-top:0;color:#1e88e5;">‚ÑπÔ∏è Game Info / Rules</h4>
<p style="font-size:12px;color:#aaa;">
Zombie Fighter TON Edition v2.0<br>
Build: Telegram WebApp<br>
Season: Apocalypse (S1)<br>
Network: TON Blockchain<br>
Withdrawals: 20 TON min, 25% fee<br>
Daily Rewards: Once every 24 hours<br>
Spin Wheel: Once every 24 hours
</p>
</div>
`;

modal.classList.add("show");
}

// Other existing functions (kept for compatibility)
function watchAd(){
let adReward = 50;
adReward = applyVIPBonus(adReward);
  
player.coins += adReward;
player.coinsEarned += adReward;
update();
toastMsg(`üì∫ +${adReward} coins from ad!${player.vipBonus > 0 ? ` (VIP +${player.vipBonus}%)` : ''}`);
}

function openWeapons(){
const modal = document.getElementById('weaponsModal');
const list = document.getElementById('weaponsList');
list.innerHTML = "";

for(let id in weapons){
let w = weapons[id];
let owned = player.ownedWeapons.includes(id);
let equipped = player.weapon === id;

let card = document.createElement("div");
card.className = "item-card";
if(owned) card.classList.add("owned");
if(equipped) card.classList.add("equipped");

card.innerHTML = `
<div class="icon">${w.icon}</div>
<div class="name">${w.name}</div>
<div class="desc">${w.desc}</div>
<div class="price">${w.price}üí∞</div>
${!owned ? 
`<button onclick="protectedBuyWeapon('${id}')" class="button-click-protected" ${player.coins >= w.price ? "" : "disabled"}>
${player.coins >= w.price ? "Buy" : "Need Coins"}
</button>` :
`<button onclick="protectedEquipWeapon('${id}')" class="button-click-protected" ${!equipped ? "" : "disabled"}>
${equipped ? "EQUIPPED" : "Equip"}
</button>`
}
${owned ? '<div class="badge">OWNED</div>' : ''}
${equipped ? '<div class="badge">EQUIPPED</div>' : ''}
`;
list.appendChild(card);
}
modal.classList.add("show");
}

function protectedBuyWeapon(id) {
protectButton(`buyWeapon_${id}`, () => buyWeapon(id), 500);
}

function buyWeapon(id){
let w = weapons[id];
if(player.coins >= w.price){
player.coins -= w.price;
player.ownedWeapons.push(id);
update();
toastMsg(`‚úÖ Bought ${w.name}!`);
openWeapons();
} else {
toastMsg("‚ùå Not enough coins!");
}
}

function protectedEquipWeapon(id) {
protectButton(`equipWeapon_${id}`, () => equipWeapon(id), 300);
}

function equipWeapon(id){
player.weapon = id;
update();
toastMsg(`‚úÖ Equipped ${weapons[id].name}`);
openWeapons();
}

function openCharacters(){
const modal = document.getElementById('charactersModal');
const list = document.getElementById('charactersList');
list.innerHTML = "";

for(let id in characters){
let ch = characters[id];
let owned = player.ownedChars.includes(id);
let equipped = player.char === id;
let canBuy = player.level >= ch.level && player.coins >= ch.price;

let card = document.createElement("div");
card.className = "item-card";
if(owned) card.classList.add("owned");
if(equipped) card.classList.add("equipped");

// Use image for ninja character
let iconHTML = '';
if (id === 'ninja' && ch.image) {
iconHTML = `<img src="${ch.image}" alt="Ninja" style="width:40px;height:40px;object-fit:contain;">`;
} else {
iconHTML = `<div class="icon">${ch.icon}</div>`;
}

card.innerHTML = `
${iconHTML}
<div class="name">${ch.name}</div>
<div class="desc">${ch.desc}</div>
<div class="price">Level ${ch.level} | ${ch.price}üí∞</div>
${!owned ? 
`<button onclick="protectedBuyChar('${id}')" class="button-click-protected" ${canBuy ? "" : "disabled"}>
${canBuy ? "Buy" : "Locked"}
</button>` :
`<button onclick="protectedEquipChar('${id}')" class="button-click-protected" ${!equipped ? "" : "disabled"}>
${equipped ? "EQUIPPED" : "Equip"}
</button>`
}
${owned ? '<div class="badge">OWNED</div>' : ''}
${equipped ? '<div class="badge">EQUIPPED</div>' : ''}
`;
list.appendChild(card);
}
modal.classList.add("show");
}

function protectedBuyChar(id) {
protectButton(`buyChar_${id}`, () => buyChar(id), 500);
}

function buyChar(id){
let ch = characters[id];
if(player.level >= ch.level && player.coins >= ch.price){
player.coins -= ch.price;
player.ownedChars.push(id);
update();
toastMsg(`‚úÖ Unlocked ${ch.name}!`);
openCharacters();
} else if(player.level < ch.level){
toastMsg(`‚ùå Need level ${ch.level}!`);
} else {
toastMsg("‚ùå Not enough coins!");
}
}

function protectedEquipChar(id) {
protectButton(`equipChar_${id}`, () => equipChar(id), 300);
}

function equipChar(id){
player.char = id;
update();
toastMsg(`‚úÖ Equipped ${characters[id].name}`);
openCharacters();
}

function openSkills(){
const modal = document.getElementById('skillsModal');
const list = document.getElementById('skillsList');
list.innerHTML = "";

let skillData = [
{id: "damage", name: "Damage Boost", desc: "Increase attack damage by +5 per level", priceBase: 100, level: skills.damage.level, max: skills.damage.max},
{id: "hp", name: "Max HP", desc: "Increase max HP by +20 per level", priceBase: 150, level: skills.hp.level, max: skills.hp.max},
{id: "crit", name: "Critical Chance", desc: "Increase critical hit chance by +10% per level", priceBase: 200, level: skills.crit.level, max: skills.crit.max}
];

skillData.forEach(s => {
let price = s.priceBase * (s.level + 1);
let div = document.createElement("div");
div.className = "skill-item";
div.innerHTML = `
<div class="skill-header">
<div class="skill-name">${s.name}</div>
<div class="skill-level">Level ${s.level}/${s.max}</div>
</div>
<div class="skill-desc">${s.desc}</div>
<button onclick="protectedUpgradeSkill('${s.id}')" class="button-click-protected" ${s.level < s.max && player.coins >= price ? "" : "disabled"}>
${s.level >= s.max ? "MAXED" : `Upgrade - ${price}üí∞`}
</button>
`;
list.appendChild(div);
});

modal.classList.add("show");
}

function protectedUpgradeSkill(id) {
protectButton(`upgradeSkill_${id}`, () => upgradeSkill(id), 500);
}

function upgradeSkill(id){
let skill = skills[id];
let price = 0;
if(id === "damage") price = 100 * (skill.level + 1);
else if(id === "hp") price = 150 * (skill.level + 1);
else if(id === "crit") price = 200 * (skill.level + 1);

if(skill.level >= skill.max){
toastMsg("‚ùå Skill already maxed!");
return;
}
if(player.coins >= price){
player.coins -= price;
skill.level++;
if(id === "hp"){
player.max = player.baseMax + (skill.level * 20);
player.hp = Math.min(player.hp + 20, player.max);
}
update();
toastMsg(`‚úÖ ${id} upgraded to level ${skill.level}!`);
openSkills();
} else {
toastMsg("‚ùå Not enough coins!");
}
}

function openStats(){
const modal = document.getElementById('statsModal');
const list = document.getElementById('statsList');
list.innerHTML = "";

let stats = [
{label: "Player Level", value: player.level},
{label: "Total Kills", value: player.kills},
{label: "Coins Earned", value: player.coinsEarned},
{label: "Total Gems", value: player.gems},
{label: "VIP Tier", value: vipTiers[player.vipTier].name},
{label: "VIP Bonus", value: `+${player.vipBonus}% coins`},
{label: "Current Energy", value: `${player.energy}/${player.energyMax}`},
{label: "Current Weapon", value: weapons[player.weapon].name},
{label: "Current Character", value: characters[player.char].name},
{label: "Referrals", value: player.referrals},
{label: "Total Spins", value: player.spinCount || 0},
{label: "Daily Claims", value: player.dailyCount || 0}
];

stats.forEach(s => {
let div = document.createElement("div");
div.className = "stat-row";
div.innerHTML = `<span class="label">${s.label}</span><span class="value">${s.value}</span>`;
list.appendChild(div);
});

modal.classList.add("show");
}

function protectedChangeName() {
protectButton('changeNameButton', changeName, 500);
}

function changeName(){
let newName = document.getElementById("playerNameInput").value.trim();
if(newName.length > 0){
player.name = newName;
update();
toastMsg("‚úÖ Name changed!");
} else {
toastMsg("‚ùå Name cannot be empty!");
}
}

function confirmReset(){
player = {
hp: 100,
max: 100,
baseMax: 100,
hpUpgrades: 0,
coins: 0,
gems: 0,
level: 1,
xp: 0,
xpMax: 100,
energy: 100,
energyMax: 100,
weapon: "sword",
char: "hero",
name: "Player",
kills: 0,
coinsEarned: 0,
referrals: 0,
referralCode: "",
ownedWeapons: ["sword"],
ownedChars: ["hero"],
soundEnabled: true,
vipTier: 0,
vipBonus: 0,
lastSpinTime: 0,
spinCount: 0,
lastDailyTime: 0,
dailyCount: 0,
achievements: {
kill100: {completed: false, claimed: false, progress: 0, target: 100},
level10: {completed: false, claimed: false, progress: 0, target: 10},
spin5: {completed: false, claimed: false, progress: 0, target: 5},
daily7: {completed: false, claimed: false, progress: 0, target: 7}
},
ownedSkins: ["common"],
activeSkin: null,
skins: {}
};
skills = {
damage: {level: 0, max: 5},
hp: {level: 0, max: 5},
crit: {level: 0, max: 3}
};
zombie = {hp: 30, max: 30};
  
// Restart timers
startTimers();
  
update();
closeModal('confirmModal');
toastMsg("‚úÖ Game reset!");
}

function openReferral(){
const modal = document.getElementById('referralModal');
const content = document.getElementById('referralContent');
content.innerHTML = `
<h3>Invite Friends & Earn!</h3>
<p style="color:#aaa;font-size:14px;">Share your code with friends to earn rewards when they join!</p>
<div class="referral-code">
<div>Your Referral Code:</div>
<div class="code">${player.referralCode}</div>
<button onclick="copyReferralCode()" style="width:100%;padding:10px;background:#4caf50;color:#fff;border:none;border-radius:8px;">
üìã Copy Code
</button>
</div>
<div style="margin-top:20px;background:rgba(255,255,255,0.05);padding:15px;border-radius:8px;">
<h4 style="margin-top:0;color:#ffc107;">Rewards</h4>
<p style="font-size:14px;color:#aaa;">‚Ä¢ Each referral: +100üí∞</p>
<p style="font-size:14px;color:#aaa;">‚Ä¢ 10 referrals: +10üíé</p>
<p style="font-size:14px;color:#aaa;">‚Ä¢ Your friends get +50üí∞ bonus</p>
</div>
<p style="text-align:center;color:#aaa;margin-top:20px;font-size:12px;">
Total Referrals: <span style="color:#4caf50;font-weight:bold;">${player.referrals}</span>
</p>
`;
modal.classList.add('show');
}

function copyReferralCode(){
navigator.clipboard.writeText(player.referralCode).then(() => {
toastMsg("‚úÖ Referral code copied!");
});
}

// Open/Close Modals
function openModal(id){
document.getElementById(id).classList.add("show");
}

function closeModal(id){
document.getElementById(id).classList.remove("show");
}

// Other existing functions (shortened for brevity)
function openProfile() { /* ... existing code ... */ }
function openShop() { /* ... existing code ... */ }
function switchShopTab(tab) { /* ... existing code ... */ }
function loadShopItems() { /* ... existing code ... */ }
function loadShopSkins() { /* ... existing code ... */ }
function openSkins() { /* ... existing code ... */ }
function previewSkinPack(packId) { /* ... existing code ... */ }
function applySkinPack(packId) { /* ... existing code ... */ }
function protectedBuySkinPack(packId) { /* ... existing code ... */ }
function openVIP() { /* ... existing code ... */ }
function purchaseVIP(tierId) { /* ... existing code ... */ }
function openInventory() { /* ... existing code ... */ }
function openAchievements() { /* ... existing code ... */ }
function protectedClaimAchievement(achievementId) { /* ... existing code ... */ }
function claimAchievement(achievementId) { /* ... existing code ... */ }
function updateWithdrawalSummary() { /* ... existing code ... */ }
function openWithdrawal() { /* ... existing code ... */ }
function processWithdrawal() { /* ... existing code ... */ }
function openWallet() { /* ... existing code ... */ }
function openBossRaid() { /* ... existing code ... */ }
function joinBossRaid() { /* ... existing code ... */ }
function openConvertGems() { /* ... existing code ... */ }
function adjustGems(amount) { /* ... existing code ... */ }
function updateConversionSummary() { /* ... existing code ... */ }
function convertGemsToTON() { /* ... existing code ... */ }
function openSeasonPass() { /* ... existing code ... */ }
function buySeasonPass() { /* ... existing code ... */ }
function openLeaderboard() { /* ... existing code ... */ }
function switchLeaderboardTab(tab) { /* ... existing code ... */ }

// Initialize
window.onload = function(){
initSounds();
loadGame();
    
// Setup button sounds
setTimeout(() => {
setupButtonSounds();
}, 500);
    
// Add event listener for withdrawal amount input
const withdrawAmountInput = document.getElementById('withdrawAmount');
if (withdrawAmountInput) {
withdrawAmountInput.addEventListener('input', updateWithdrawalSummary);
withdrawAmountInput.addEventListener('change', updateWithdrawalSummary);
}
    
// Mobile responsiveness for Telegram WebView
if (window.Telegram?.WebApp) {
// Ensure viewport works correctly
document.documentElement.style.height = '100%';
document.body.style.height = '100%';
document.body.style.overflow = 'auto';
        
// Expand to full screen
tg.expand();
        
// Handle safe areas
const safeAreaBottom = tg.safeAreaInsets.bottom || 0;
if (safeAreaBottom > 0) {
document.querySelector('.bottom-menu').style.paddingBottom = `${safeAreaBottom + 8}px`;
}
}
};

// Close modal when clicking outside
window.onclick = function(event){
if(event.target.classList.contains('modal')){
event.target.classList.remove('show');
}
}
</script>
</body>
</html>
