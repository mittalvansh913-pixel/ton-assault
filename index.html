<script>
document.addEventListener("DOMContentLoaded",()=>{

/* ===== SAFE ELEMENT GETTER ===== */
const $ = id => document.getElementById(id);

/* ===== GLOBAL ELEMENTS ===== */
const playerName = $("playerName");
const level = $("level");
const coins = $("coins");
const gems = $("gems");
const hp = $("hp");
const hpmax = $("hpmax");
const hpbar = $("hpbar");
const zhp = $("zhp");
const zbar = $("zbar");
const toast = $("toast");
const playerChar = $("playerChar");
const zombieChar = $("zombieChar");
const refModal = $("refModal");
const refCode = $("refCode");
const refLink = $("refLink");
const refCount = $("refCount");
const settingsModal = $("settingsModal");
const nameInput = $("nameInput");

/* ===== STATE ===== */
let sound = true;

let player = {
  name:"Player",
  hp:100,max:100,
  coins:0,gems:0,
  level:1,exp:0,
  damage:10,
  energy:10,
  weapon:"sword",
  skill:false,
  character:"hero",
  kills:0,
  refCode:"",
  refCount:0
};

let zombie = { hp:30, max:30, damage:5, boss:false };
let lastAd = 0;

/* ===== LOAD (SAFE) ===== */
try{
  const save = JSON.parse(localStorage.getItem("zf"));
  if(save && save.name) player = {...player, ...save};
}catch(e){
  localStorage.removeItem("zf");
}

if(!player.refCode){
  player.refCode="ZF"+Math.random().toString(36).substr(2,5).toUpperCase();
}

/* ===== UPDATE UI ===== */
function update(){
  if(!playerName) return;

  playerName.textContent = player.name;
  level.textContent = player.level;
  coins.textContent = player.coins;
  gems.textContent = player.gems;

  hp.textContent = player.hp;
  hpmax.textContent = player.max;
  hpbar.style.width = (player.hp/player.max*100)+"%";

  zhp.textContent = zombie.hp+"/"+zombie.max;
  zbar.style.width = (zombie.hp/zombie.max*100)+"%";

  localStorage.setItem("zf",JSON.stringify(player));
}

/* ===== TOAST ===== */
function toastMsg(t){
  toast.textContent = t;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),1500);
}

/* ===== ZOMBIE ===== */
function spawnZombie(){
  zombie.boss = player.kills>0 && player.kills%5===0;
  zombie.max = zombie.boss ? 150+player.level*20 : 30+player.level*10;
  zombie.hp = zombie.max;
  zombieChar.textContent = zombie.boss ? "ðŸ‘¹" : "ðŸ§Ÿ";
  if(zombie.boss) toastMsg("ðŸ‘¹ BOSS ZOMBIE!");
}

/* ===== ATTACK ===== */
window.attack = function(){
  if(player.energy<=0) return toastMsg("âš¡ No Energy");

  player.energy--;

  playerChar.classList.add("attack");
  zombieChar.classList.add("hit");

  let dmg = player.damage;
  let crit = player.skill && Math.random()<0.25;
  if(crit) dmg*=2;

  zombie.hp -= dmg;
  floatText((crit?"âš¡ ":"-")+dmg,zombieChar);

  if(zombie.hp<=0){
    player.kills++;
    player.coins += zombie.boss ? 50 : 10;
    player.exp += 20;
    levelCheck();
    coinSound();
    toastMsg(zombie.boss?"+50ðŸ’° Boss":"+10ðŸ’°");
    spawnZombie();
  }

  setTimeout(()=>{
    playerChar.classList.remove("attack");
    zombieChar.classList.remove("hit");
  },200);

  update();
}

/* ===== LEVEL ===== */
function levelCheck(){
  if(player.exp>=player.level*100){
    player.exp=0;
    player.level++;
    player.max+=20;
    player.hp=player.max;
    player.damage+=2;
    toastMsg("â­ LEVEL UP!");
  }
}

/* ===== ENERGY REGEN ===== */
setInterval(()=>{
  if(player.energy<10){
    player.energy++;
    update();
  }
},4000);

/* ===== FLOAT TEXT ===== */
function floatText(txt,el){
  const d=document.createElement("div");
  d.className="float";
  d.textContent=txt;
  el.appendChild(d);
  setTimeout(()=>d.remove(),1000);
}

/* ===== EARNING ===== */
window.watchAd = function(){
  if(Date.now()-lastAd<30000) return toastMsg("â³ Wait");
  lastAd=Date.now();
  player.coins+=20;
  toastMsg("+20ðŸ’°");
  update();
}

window.daily = function(){
  const d=localStorage.getItem("daily")||0;
  if(Date.now()-d<86400000) return toastMsg("Tomorrow");
  player.coins+=50;
  localStorage.setItem("daily",Date.now());
  toastMsg("+50ðŸ’°");
  update();
}

window.spin = function(){
  if(player.gems<1) return toastMsg("Need 1ðŸ’Ž");
  player.gems--;
  const r=[10,20,50,0][Math.floor(Math.random()*4)];
  player.coins+=r;
  toastMsg("Won "+r+"ðŸ’°");
  update();
}

/* ===== REFERRAL ===== */
window.openReferral = function(){
  refModal.style.display="flex";
  refCode.textContent=player.refCode;
  refLink.value="https://yourgame.site/?ref="+player.refCode;
  refCount.textContent=player.refCount;
}

window.confirmInvite = function(){
  player.refCount++;
  player.coins+=50;
  toastMsg("+50ðŸ’° Referral");
  update();
}

/* ===== SETTINGS ===== */
window.openSettings = function(){
  settingsModal.style.display="flex";
  nameInput.value=player.name;
}

window.saveSettings = function(){
  player.name=nameInput.value||"Player";
  toastMsg("Settings Saved");
  closeAll();
  update();
}

window.toggleSound = function(){
  sound=!sound;
  toastMsg(sound?"ðŸ”Š Sound ON":"ðŸ”‡ Sound OFF");
}

function coinSound(){
  if(!sound) return;
  new Audio("https://assets.mixkit.co/sfx/preview/mixkit-coin-win-notification-1992.mp3").play();
}

/* ===== UTILS ===== */
window.closeAll = function(){
  document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}

/* ===== INIT ===== */
spawnZombie();
update();

});
</script>
