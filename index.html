import React, { useState, useEffect, useRef } from 'react';
import { Sword, Coins, Gem, Heart, Zap, Trophy, Gift } from 'lucide-react';

const ZombieGame = () => {
  const [player, setPlayer] = useState({
    health: 100,
    maxHealth: 100,
    coins: 0,
    gems: 0,
    level: 1,
    exp: 0,
    damage: 10
  });
  
  const [zombie, setZombie] = useState(null);
  const [isAttacking, setIsAttacking] = useState(false);
  const [zombieAttacking, setZombieAttacking] = useState(false);
  const [gameStarted, setGameStarted] = useState(false);
  const [notifications, setNotifications] = useState([]);
  const [tasks, setTasks] = useState([
    { id: 1, name: 'Kill 5 Zombies', progress: 0, target: 5, reward: { coins: 50, gems: 5 }, completed: false },
    { id: 2, name: 'Collect 100 Coins', progress: 0, target: 100, reward: { gems: 10 }, completed: false },
    { id: 3, name: 'Reach Level 3', progress: 1, target: 3, reward: { coins: 100, gems: 20 }, completed: false }
  ]);
  const [showTasks, setShowTasks] = useState(false);
  const [kills, setKills] = useState(0);
  
  const audioContext = useRef(null);

  useEffect(() => {
    audioContext.current = new (window.AudioContext || window.webkitAudioContext)();
  }, []);

  const playSound = (type) => {
    if (!audioContext.current) return;
    
    const ctx = audioContext.current;
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    switch(type) {
      case 'attack':
        oscillator.frequency.value = 200;
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.1);
        break;
      case 'hit':
        oscillator.frequency.value = 100;
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.15);
        break;
      case 'coin':
        oscillator.frequency.value = 800;
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.2);
        break;
      case 'gem':
        oscillator.frequency.value = 1200;
        gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.3);
        break;
      case 'levelup':
        oscillator.frequency.value = 600;
        gainNode.gain.setValueAtTime(0.25, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.5);
        break;
    }
  };

  const addNotification = (message, type = 'info') => {
    const id = Date.now();
    setNotifications(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setNotifications(prev => prev.filter(n => n.id !== id));
    }, 2000);
  };

  const spawnZombie = () => {
    const zombieHealth = 30 + (player.level * 10);
    setZombie({
      health: zombieHealth,
      maxHealth: zombieHealth,
      damage: 5 + (player.level * 2)
    });
  };

  const attackZombie = () => {
    if (!zombie || isAttacking) return;
    
    setIsAttacking(true);
    playSound('attack');
    
    setTimeout(() => {
      const damage = player.damage + Math.floor(Math.random() * 5);
      const newHealth = Math.max(0, zombie.health - damage);
      
      setZombie(prev => ({ ...prev, health: newHealth }));
      playSound('hit');
      
      if (newHealth <= 0) {
        const coinsEarned = 10 + Math.floor(Math.random() * 10) + (player.level * 5);
        const gemsEarned = Math.random() < 0.3 ? Math.floor(Math.random() * 3) + 1 : 0;
        const expGained = 20;
        
        setPlayer(prev => ({
          ...prev,
          coins: prev.coins + coinsEarned,
          gems: prev.gems + gemsEarned,
          exp: prev.exp + expGained
        }));
        
        setKills(prev => prev + 1);
        updateTaskProgress(1, 1);
        
        playSound('coin');
        if (gemsEarned > 0) playSound('gem');
        
        addNotification(`+${coinsEarned} Coins${gemsEarned > 0 ? ` +${gemsEarned} Gems` : ''}`, 'success');
        
        setTimeout(() => spawnZombie(), 500);
      } else {
        setTimeout(() => zombieCounterAttack(), 300);
      }
      
      setIsAttacking(false);
    }, 200);
  };

  const zombieCounterAttack = () => {
    if (!zombie) return;
    
    setZombieAttacking(true);
    playSound('attack');
    
    setTimeout(() => {
      const damage = zombie.damage;
      setPlayer(prev => ({
        ...prev,
        health: Math.max(0, prev.health - damage)
      }));
      
      playSound('hit');
      addNotification(`-${damage} HP`, 'danger');
      setZombieAttacking(false);
    }, 300);
  };

  const heal = () => {
    if (player.coins < 20) {
      addNotification('Not enough coins!', 'danger');
      return;
    }
    
    setPlayer(prev => ({
      ...prev,
      coins: prev.coins - 20,
      health: Math.min(prev.maxHealth, prev.health + 30)
    }));
    
    playSound('gem');
    addNotification('+30 HP', 'success');
  };

  const updateTaskProgress = (taskId, amount) => {
    setTasks(prev => prev.map(task => {
      if (task.id === taskId && !task.completed) {
        const newProgress = task.progress + amount;
        if (newProgress >= task.target) {
          claimTaskReward(task);
          return { ...task, progress: task.target, completed: true };
        }
        return { ...task, progress: newProgress };
      }
      return task;
    }));
  };

  const claimTaskReward = (task) => {
    setPlayer(prev => ({
      ...prev,
      coins: prev.coins + (task.reward.coins || 0),
      gems: prev.gems + (task.reward.gems || 0)
    }));
    
    playSound('gem');
    addNotification(`Task Completed! +${task.reward.coins || 0} Coins +${task.reward.gems || 0} Gems`, 'success');
  };

  useEffect(() => {
    updateTaskProgress(2, player.coins - (tasks[1]?.progress || 0));
  }, [player.coins]);

  useEffect(() => {
    const expNeeded = player.level * 100;
    if (player.exp >= expNeeded) {
      setPlayer(prev => ({
        ...prev,
        level: prev.level + 1,
        exp: prev.exp - expNeeded,
        maxHealth: prev.maxHealth + 20,
        health: prev.maxHealth + 20,
        damage: prev.damage + 5
      }));
      
      playSound('levelup');
      addNotification(`Level Up! Now Level ${player.level + 1}`, 'success');
      updateTaskProgress(3, 1);
    }
  }, [player.exp]);

  useEffect(() => {
    if (player.health <= 0) {
      addNotification('Game Over! Starting new game...', 'danger');
      setTimeout(() => {
        setPlayer({
          health: 100,
          maxHealth: 100,
          coins: 0,
          gems: 0,
          level: 1,
          exp: 0,
          damage: 10
        });
        setZombie(null);
        setGameStarted(false);
        setKills(0);
      }, 2000);
    }
  }, [player.health]);

  const startGame = () => {
    setGameStarted(true);
    spawnZombie();
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-purple-900 via-purple-800 to-indigo-900 text-white p-4">
      {/* Notifications */}
      <div className="fixed top-4 right-4 z-50 space-y-2">
        {notifications.map(notif => (
          <div
            key={notif.id}
            className={`px-4 py-2 rounded-lg shadow-lg animate-pulse ${
              notif.type === 'success' ? 'bg-green-500' :
              notif.type === 'danger' ? 'bg-red-500' :
              'bg-blue-500'
            }`}
          >
            {notif.message}
          </div>
        ))}
      </div>

      {/* Header Stats */}
      <div className="max-w-2xl mx-auto">
        <div className="bg-black bg-opacity-50 rounded-lg p-4 mb-4">
          <div className="flex justify-between items-center mb-3">
            <div className="flex items-center gap-2">
              <Trophy className="text-yellow-400" size={20} />
              <span className="font-bold">Level {player.level}</span>
            </div>
            <div className="flex gap-4">
              <div className="flex items-center gap-1">
                <Coins className="text-yellow-400" size={20} />
                <span className="font-bold">{player.coins}</span>
              </div>
              <div className="flex items-center gap-1">
                <Gem className="text-cyan-400" size={20} />
                <span className="font-bold">{player.gems}</span>
              </div>
            </div>
          </div>
          
          <div className="space-y-2">
            <div>
              <div className="flex justify-between text-sm mb-1">
                <span className="flex items-center gap-1">
                  <Heart className="text-red-500" size={16} />
                  HP: {player.health}/{player.maxHealth}
                </span>
                <span>Kills: {kills}</span>
              </div>
              <div className="w-full bg-gray-700 rounded-full h-3">
                <div
                  className="bg-gradient-to-r from-red-500 to-pink-500 h-3 rounded-full transition-all"
                  style={{ width: `${(player.health / player.maxHealth) * 100}%` }}
                />
              </div>
            </div>
            
            <div>
              <div className="flex justify-between text-sm mb-1">
                <span className="flex items-center gap-1">
                  <Zap className="text-yellow-400" size={16} />
                  EXP
                </span>
                <span>{player.exp}/{player.level * 100}</span>
              </div>
              <div className="w-full bg-gray-700 rounded-full h-2">
                <div
                  className="bg-gradient-to-r from-yellow-400 to-orange-500 h-2 rounded-full transition-all"
                  style={{ width: `${(player.exp / (player.level * 100)) * 100}%` }}
                />
              </div>
            </div>
          </div>
        </div>

        {/* Game Area */}
        {!gameStarted ? (
          <div className="text-center py-20">
            <h1 className="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
              Zombie Fighter
            </h1>
            <p className="text-xl mb-8">Fight zombies, earn coins and gems!</p>
            <button
              onClick={startGame}
              className="bg-gradient-to-r from-green-500 to-emerald-600 px-8 py-4 rounded-lg text-xl font-bold hover:scale-105 transition-transform shadow-lg"
            >
              Start Game
            </button>
          </div>
        ) : (
          <>
            {/* Battle Area */}
            <div className="bg-black bg-opacity-50 rounded-lg p-6 mb-4 min-h-64">
              <div className="flex justify-between items-center">
                {/* Player */}
                <div className="text-center">
                  <div className={`text-6xl transition-transform ${isAttacking ? 'scale-125' : 'scale-100'}`}>
                    ü¶∏‚Äç‚ôÇÔ∏è
                  </div>
                  <div className="mt-2 font-bold">You</div>
                  <div className="text-sm">DMG: {player.damage}</div>
                </div>

                {/* VS */}
                <div className="text-4xl font-bold text-red-500">‚öîÔ∏è</div>

                {/* Zombie */}
                {zombie && (
                  <div className="text-center">
                    <div className={`text-6xl transition-transform ${zombieAttacking ? 'scale-125' : 'scale-100'}`}>
                      üßü
                    </div>
                    <div className="mt-2 font-bold text-red-400">Zombie</div>
                    <div className="w-32 bg-gray-700 rounded-full h-2 mt-2">
                      <div
                        className="bg-red-500 h-2 rounded-full transition-all"
                        style={{ width: `${(zombie.health / zombie.maxHealth) * 100}%` }}
                      />
                    </div>
                    <div className="text-sm mt-1">{zombie.health}/{zombie.maxHealth}</div>
                  </div>
                )}
              </div>
            </div>

            {/* Action Buttons */}
            <div className="grid grid-cols-2 gap-3 mb-4">
              <button
                onClick={attackZombie}
                disabled={!zombie || isAttacking || player.health <= 0}
                className="bg-gradient-to-r from-red-600 to-red-700 px-6 py-4 rounded-lg font-bold hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                <Sword size={20} />
                Attack
              </button>
              
              <button
                onClick={heal}
                disabled={player.health >= player.maxHealth || player.coins < 20}
                className="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4 rounded-lg font-bold hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                <Heart size={20} />
                Heal (20 üí∞)
              </button>
            </div>

            {/* Tasks Button */}
            <button
              onClick={() => setShowTasks(!showTasks)}
              className="w-full bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-3 rounded-lg font-bold hover:scale-105 transition-transform flex items-center justify-center gap-2 mb-4"
            >
              <Gift size={20} />
              Tasks {tasks.filter(t => !t.completed).length > 0 && `(${tasks.filter(t => !t.completed).length})`}
            </button>

            {/* Tasks Panel */}
            {showTasks && (
              <div className="bg-black bg-opacity-50 rounded-lg p-4 space-y-3">
                {tasks.map(task => (
                  <div
                    key={task.id}
                    className={`bg-gray-800 p-3 rounded-lg ${task.completed ? 'opacity-50' : ''}`}
                  >
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <div className="font-bold">{task.name}</div>
                        <div className="text-sm text-gray-400">
                          Reward: {task.reward.coins && `${task.reward.coins} üí∞`} {task.reward.gems && `${task.reward.gems} üíé`}
                        </div>
                      </div>
                      {task.completed && (
                        <span className="text-green-400 font-bold">‚úì</span>
                      )}
                    </div>
                    <div className="w-full bg-gray-700 rounded-full h-2">
                      <div
                        className="bg-blue-500 h-2 rounded-full transition-all"
                        style={{ width: `${(task.progress / task.target) * 100}%` }}
                      />
                    </div>
                    <div className="text-xs text-gray-400 mt-1">
                      {task.progress}/{task.target}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
};

export default ZombieGame;
