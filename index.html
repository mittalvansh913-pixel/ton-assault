<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zombie Fighter - TON Edition</title>

<!-- âœ¨ NEW: Favicon and App Icons -->
<link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>ğŸ§Ÿ</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>ğŸ§Ÿ</text></svg>">

<style>
body{
margin:0;font-family:Arial;color:#fff;overflow:hidden;
background:linear-gradient(#2b1055,#1a043a);
}

/* BACKGROUND */
.bg span{
position:fixed;width:10px;height:10px;
background:rgba(255,255,255,0.15);
border-radius:50%;
animation:float 15s linear infinite;
}
@keyframes float{
from{transform:translateY(110vh)}
to{transform:translateY(-10vh)}
}

.container{max-width:420px;margin:auto;padding:15px;text-align:center;position:relative;z-index:5}
.top{background:rgba(0,0,0,.4);border-radius:12px;padding:12px;display:flex;justify-content:space-between}
.stat{font-weight:bold;font-size:13px}

.bar{background:#444;border-radius:8px;overflow:hidden;height:10px;margin-top:5px}
.bar div{height:100%;transition:width 0.3s}

.xp-bar-container{margin:5px 0}
.xp-bar{background:#444;border-radius:8px;overflow:hidden;height:8px;margin-top:3px}
.xp-bar div{height:100%;background:linear-gradient(90deg, #ffc107, #ff9800);transition:width 0.5s}

.game{background:rgba(0,0,0,.4);border-radius:12px;padding:20px;margin:10px 0}
.fighters{font-size:48px;display:flex;justify-content:space-between;align-items:center}

#playerChar.attack{animation:attack .2s}
#zombieChar.hit{animation:hit .2s}

.game.shake{animation:shake 0.3s}
@keyframes shake{
0%, 100%{transform:translateX(0)}
25%{transform:translateX(-5px)}
75%{transform:translateX(5px)}
}

.game.levelup{animation:levelupGlow 0.8s}
@keyframes levelupGlow{
0%, 100%{box-shadow:0 0 0 rgba(255,193,7,0)}
50%{box-shadow:0 0 30px rgba(255,193,7,0.8)}
}

.hp-low{animation:hpWarning 1s infinite}
@keyframes hpWarning{
0%, 100%{color:#fff}
50%{color:#ff5252}
}

@keyframes attack{50%{transform:translateX(20px)}}
@keyframes hit{50%{transform:translateX(-15px)}}

button{padding:10px 20px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;background:#1e88e5;color:#fff;font-size:16px}
button:active{transform:scale(0.95)}
button:disabled{opacity:0.5;cursor:not-allowed}

/* SIDE MENUS */
.side-menu{position:fixed;top:30%;display:flex;flex-direction:column;gap:10px;z-index:99}
.side-menu.left{left:10px}
.side-menu.right{right:10px}
.side-btn{
width:50px;height:50px;border-radius:50%;
background:#1e88e5;color:#fff;
display:flex;align-items:center;justify-content:center;
font-size:20px;cursor:pointer;
box-shadow:0 4px 8px rgba(0,0,0,0.3);
}
.side-btn:active{transform:scale(0.9)}

/* MODALS */
.modal{
position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,.85);
display:none;align-items:center;justify-content:center;z-index:200;
overflow-y:auto;padding:20px;box-sizing:border-box;
}
.modal.show{display:flex}
.modal-box{
background:#1a1a2e;padding:20px;border-radius:12px;width:100%;max-width:380px;
max-height:90vh;overflow-y:auto;
}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.modal-header h2{margin:0;font-size:20px}
.close-btn{background:#ff5252;color:#fff;border:none;padding:5px 15px;border-radius:8px;cursor:pointer;font-size:18px}

/* ITEM CARDS */
.item-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.item-card{
background:rgba(255,255,255,0.05);border-radius:10px;padding:15px;
border:2px solid #444;position:relative;
}
.item-card.owned{border-color:#4caf50}
.item-card.equipped{border-color:#ffc107;background:rgba(255,193,7,0.1)}
.item-card .icon{font-size:40px}
.item-card .name{font-weight:bold;margin:5px 0}
.item-card .desc{font-size:12px;color:#aaa}
.item-card .price{color:#ffc107;margin-top:8px}
.item-card button{padding:6px 12px;font-size:12px;margin-top:8px;width:100%}
.item-card .badge{
position:absolute;top:5px;right:5px;
background:#ffc107;color:#000;padding:2px 6px;
border-radius:5px;font-size:10px;font-weight:bold;
}

/* SKILL ITEMS */
.skill-item{
background:rgba(255,255,255,0.05);border-radius:10px;padding:12px;
border:2px solid #444;margin-bottom:10px;
}
.skill-item .skill-header{display:flex;justify-content:space-between;align-items:center}
.skill-item .skill-name{font-weight:bold;font-size:16px}
.skill-item .skill-level{color:#4caf50;font-size:14px}
.skill-item .skill-desc{font-size:13px;color:#aaa;margin:5px 0}
.skill-item button{padding:6px 12px;font-size:12px;width:100%;margin-top:5px}

/* âœ¨ NEW: Task Items */
.task-item{
background:rgba(255,255,255,0.05);border-radius:10px;padding:12px;
border:2px solid #444;margin-bottom:10px;
}
.task-item.completed{border-color:#4caf50;opacity:0.7}
.task-item .task-header{display:flex;justify-content:space-between;align-items:center}
.task-item .task-title{font-weight:bold;font-size:15px}
.task-item .task-reward{color:#0088cc;font-size:13px}
.task-item button{padding:6px 12px;font-size:12px;width:100%;margin-top:8px}

/* STATS PAGE */
.stat-row{
display:flex;justify-content:space-between;
background:rgba(255,255,255,0.05);padding:12px;
border-radius:8px;margin-bottom:8px;
}
.stat-row .label{color:#aaa}
.stat-row .value{font-weight:bold;color:#4caf50}

/* SETTINGS */
.setting-item{
background:rgba(255,255,255,0.05);padding:12px;
border-radius:8px;margin-bottom:10px;
}
.setting-item label{display:flex;justify-content:space-between;align-items:center}
.setting-item input[type="text"]{
width:100%;padding:8px;border-radius:6px;border:1px solid #444;
background:#0f0f1e;color:#fff;margin-top:5px;
}
.setting-item input[type="checkbox"]{
width:40px;height:20px;cursor:pointer;
}

/* âœ¨ NEW: Wallet Status */
.wallet-status{
background:rgba(0,136,204,0.2);
border:1px solid #0088cc;
padding:10px;
border-radius:8px;
margin:10px 0;
font-size:13px;
}
.wallet-connected{color:#4caf50}
.wallet-disconnected{color:#ff9800}

/* REFERRAL */
.referral-code{
background:rgba(255,255,255,0.1);padding:15px;
border-radius:8px;text-align:center;margin:10px 0;
}
.referral-code .code{
font-size:24px;font-weight:bold;letter-spacing:2px;
color:#ffc107;margin:10px 0;
}

/* SPIN WHEEL STYLES */
.wheel-container{
position:relative;
width:280px;
height:280px;
margin:20px auto;
}
.wheel{
width:100%;
height:100%;
border-radius:50%;
position:relative;
overflow:hidden;
box-shadow:0 0 20px rgba(0,136,204,0.5);
transition:transform 3s cubic-bezier(0.17, 0.67, 0.12, 0.99);
}
.wheel-slice{
position:absolute;
width:50%;
height:50%;
transform-origin:100% 100%;
clip-path:polygon(0 0, 100% 0, 100% 100%);
display:flex;
align-items:center;
justify-content:center;
font-weight:bold;
font-size:16px;
}
.wheel-pointer{
position:absolute;
top:-10px;
left:50%;
transform:translateX(-50%);
width:0;
height:0;
border-left:15px solid transparent;
border-right:15px solid transparent;
border-top:25px solid #ff5252;
z-index:10;
}
.wheel-center{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%, -50%);
width:70px;
height:70px;
background:#1a1a2e;
border-radius:50%;
border:3px solid #0088cc;
display:flex;
align-items:center;
justify-content:center;
font-size:32px;
z-index:5;
}
.spin-result{
font-size:18px;
font-weight:bold;
color:#0088cc;
margin-top:15px;
min-height:30px;
}

/* âœ¨ NEW: Timer display */
.timer-display{
color:#ff9800;
font-size:16px;
font-weight:bold;
margin:10px 0;
}

/* FLOAT DAMAGE */
.float{
position:absolute;
color:#ff5252;
font-weight:bold;
font-size:20px;
animation:floatUp 1s forwards;
pointer-events:none;
}
@keyframes floatUp{
to{transform:translateY(-40px);opacity:0}
}

/* TOAST */
#toast{
position:fixed;bottom:80px;left:50%;
transform:translateX(-50%);
background:#000;padding:10px 20px;border-radius:20px;
opacity:0;transition:.3s;z-index:300;
}
#toast.show{opacity:1}

/* BOTTOM MENU */
.bottom-menu{
position:fixed;
bottom:0;left:0;width:100%;
background:rgba(0,0,0,.7);
border-top:2px solid #555;
display:flex;
justify-content:space-around;
padding:8px 0;
z-index:150;
}
.bottom-btn{
flex:1;margin:0 6px;
border:1px solid #666;
border-radius:12px;
background:#111;
padding:6px 0;
text-align:center;
font-size:14px;
cursor:pointer;
}
.bottom-btn:active{background:#222}

/* CONFIRM DIALOG */
.confirm-dialog{
background:#1a1a2e;padding:20px;border-radius:12px;
text-align:center;max-width:300px;
}
.confirm-dialog h3{margin-top:0}
.confirm-dialog .buttons{display:flex;gap:10px;margin-top:15px}
.confirm-dialog button{flex:1;padding:10px}
</style>
</head>

<body>

<div class="bg">
<script>
for(let i=0;i<40;i++){
document.write(`<span style="left:${Math.random()*100}%;animation-delay:${Math.random()*10}s"></span>`);
}
</script>
</div>

<div class="container">
<div class="top">
<div class="stat">ğŸ‘¤ <span id="playerName">Player</span></div>
<div class="stat">â­ <span id="level">1</span></div>
<!-- âœ¨ MODIFIED: Replaced gems with TON -->
<div class="stat">ğŸ’° <span id="coins">0</span> | ğŸ’ <span id="ton">0</span> TON</div>
</div>

<div class="xp-bar-container">
âš¡ XP <span id="xp">0</span>/<span id="xpmax">100</span>
<div class="xp-bar"><div id="xpbar" style="width:0%;background:linear-gradient(90deg, #ffc107, #ff9800)"></div></div>
</div>

<div id="hpContainer">
<span id="hpLabel">â¤ï¸ HP</span> <span id="hp">100</span>/<span id="hpmax">100</span>
<div class="bar"><div id="hpbar" style="width:100%;background:red"></div></div>
</div>

<div class="game" id="gameContainer">
<div class="fighters">
<div id="playerChar">ğŸ¦¸â€â™‚ï¸</div> âš”ï¸ <div id="zombieChar">ğŸ§Ÿ</div>
</div>
<div id="zhp">30/30</div>
<div class="bar"><div id="zbar" style="width:100%;background:green"></div></div>
</div>

<button onclick="attack()">âš”ï¸ Attack</button>
</div>

<!-- SIDE MENUS -->
<div class="side-menu left">
<div class="side-btn" onclick="watchAd()">ğŸ“º</div>
<div class="side-btn" onclick="openDaily()">ğŸ</div>
<div class="side-btn" onclick="openReferral()">ğŸ‘¥</div>
<div class="side-btn" onclick="openSpinWheel()">ğŸ¡</div>
</div>

<div class="side-menu right">
<div class="side-btn" onclick="openWeapons()">âš”ï¸</div>
<div class="side-btn" onclick="openSkills()">âœ¨</div>
<div class="side-btn" onclick="openCharacters()">ğŸ§™</div>
<div class="side-btn" onclick="openStats()">ğŸ“Š</div>
<div class="side-btn" onclick="openSettings()">âš™ï¸</div>
</div>

<!-- BOTTOM MENU -->
<!-- âœ¨ MODIFIED: Added new menu items -->
<div class="bottom-menu">
<div class="bottom-btn" onclick="openWeapons()">âš”ï¸</div>
<div class="bottom-btn" onclick="openCharacters()">ğŸ§™</div>
<div class="bottom-btn" onclick="openTasks()">ğŸ“‹</div>
<div class="bottom-btn" onclick="openShop()">ğŸ›’</div>
</div>

<!-- WEAPONS MODAL -->
<div id="weaponsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>âš”ï¸ Weapons</h2>
<button class="close-btn" onclick="closeModal('weaponsModal')">âœ•</button>
</div>
<div id="weaponsList" class="item-grid"></div>
</div>
</div>

<!-- CHARACTERS MODAL -->
<div id="charactersModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>ğŸ§™ Characters</h2>
<button class="close-btn" onclick="closeModal('charactersModal')">âœ•</button>
</div>
<div id="charactersList" class="item-grid"></div>
</div>
</div>

<!-- SKILLS MODAL -->
<div id="skillsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>âœ¨ Skills & Upgrades</h2>
<button class="close-btn" onclick="closeModal('skillsModal')">âœ•</button>
</div>
<div id="skillsList"></div>
</div>
</div>

<!-- STATS MODAL -->
<div id="statsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>ğŸ“Š Statistics</h2>
<button class="close-btn" onclick="closeModal('statsModal')">âœ•</button>
</div>
<div id="statsList"></div>
</div>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>âš™ï¸ Settings</h2>
<button class="close-btn" onclick="closeModal('settingsModal')">âœ•</button>
</div>
<div id="settingsList"></div>
</div>
</div>

<!-- REFERRAL MODAL -->
<div id="referralModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>ğŸ‘¥ Referrals</h2>
<button class="close-btn" onclick="closeModal('referralModal')">âœ•</button>
</div>
<div id="referralContent"></div>
</div>
</div>

<!-- âœ¨ NEW: DAILY REWARD MODAL -->
<div id="dailyModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>ğŸ Daily Reward</h2>
<button class="close-btn" onclick="closeModal('dailyModal')">âœ•</button>
</div>
<div id="dailyContent"></div>
</div>
</div>

<!-- SPIN WHEEL MODAL -->
<div id="spinModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>ğŸ¡ Spin the Wheel ğŸ¥º</h2>
<button class="close-btn" onclick="closeModal('spinModal')">âœ•</button>
</div>
<div class="wheel-container">
<div class="wheel-pointer"></div>
<div class="wheel" id="wheel"></div>
<!-- âœ¨ MODIFIED: Character icon in center -->
<div class="wheel-center" id="wheelCenter">ğŸ¦¸â€â™‚ï¸</div>
</div>
<div class="spin-result" id="spinResult"></div>
<div class="timer-display" id="spinTimer"></div>
<button id="spinButton" onclick="spinWheel()" style="width:100%;padding:12px;margin-top:10px">
ğŸ° SPIN (Free)
</button>
</div>
</div>

<!-- âœ¨ NEW: TASKS MODAL -->
<div id="tasksModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>ğŸ“‹ Weekly Tasks</h2>
<button class="close-btn" onclick="closeModal('tasksModal')">âœ•</button>
</div>
<div id="tasksContent"></div>
</div>
</div>

<!-- âœ¨ NEW: SHOP MODAL -->
<div id="shopModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>ğŸ›’ Shop ğŸ˜€</h2>
<button class="close-btn" onclick="closeModal('shopModal')">âœ•</button>
</div>
<div id="shopContent"></div>
</div>
</div>

<!-- âœ¨ NEW: WITHDRAWAL MODAL -->
<div id="withdrawModal" class="modal">
<div class="modal-box">
<div class="modal-header">
<h2>ğŸ’¸ Withdrawal</h2>
<button class="close-btn" onclick="closeModal('withdrawModal')">âœ•</button>
</div>
<div id="withdrawContent"></div>
</div>
</div>

<!-- CONFIRM DIALOG -->
<div id="confirmModal" class="modal">
<div class="confirm-dialog" id="confirmContent">
<h3>âš ï¸ Confirm</h3>
<p>Are you sure?</p>
<div class="buttons">
<button onclick="closeModal('confirmModal')">Cancel</button>
<button onclick="confirmAction()" style="background:#ff5252">Confirm</button>
</div>
</div>
</div>

<div id="toast"></div>

<script>
// Sound Effects System
const sounds = {
attack: null,
hit: null,
death: null,
coin: null,
levelup: null,
spin: null
};

function initSounds(){
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

sounds.play = function(type){
if(!player.soundEnabled) return;

const ctx = audioContext;
const oscillator = ctx.createOscillator();
const gainNode = ctx.createGain();

oscillator.connect(gainNode);
gainNode.connect(ctx.destination);

switch(type){
case 'attack':
oscillator.frequency.value = 300;
gainNode.gain.value = 0.1;
oscillator.start();
oscillator.stop(ctx.currentTime + 0.1);
break;
case 'hit':
oscillator.frequency.value = 150;
gainNode.gain.value = 0.15;
oscillator.start();
oscillator.stop(ctx.currentTime + 0.15);
break;
case 'death':
oscillator.frequency.value = 100;
gainNode.gain.value = 0.2;
oscillator.start();
oscillator.stop(ctx.currentTime + 0.3);
break;
case 'coin':
oscillator.frequency.value = 800;
gainNode.gain.value = 0.08;
oscillator.start();
oscillator.stop(ctx.currentTime + 0.1);
break;
case 'levelup':
oscillator.frequency.value = 600;
gainNode.gain.value = 0.12;
oscillator.start();
oscillator.stop(ctx.currentTime + 0.2);
setTimeout(() => {
const osc2 = ctx.createOscillator();
const gain2 = ctx.createGain();
osc2.connect(gain2);
gain2.connect(ctx.destination);
osc2.frequency.value = 800;
gain2.gain.value = 0.12;
osc2.start();
osc2.stop(ctx.currentTime + 0.2);
}, 100);
break;
case 'spin':
oscillator.frequency.value = 400;
gainNode.gain.value = 0.1;
oscillator.start();
oscillator.stop(ctx.currentTime + 0.05);
break;
}
};
}

// Initialize Telegram WebApp
let tg = window.Telegram?.WebApp;
if(tg){
tg.ready();
tg.expand();
}

// âœ¨ MODIFIED: Game State with TON integration
let player = {
hp: 100,
max: 100,
baseMax: 100,
hpUpgrades: 0,
coins: 0,
ton: 0, // âœ¨ NEW: TON balance (replaces gems)
level: 1,
xp: 0,
xpMax: 100,
weapon: "sword",
char: "hero",
name: "Player",
kills: 0,
coinsEarned: 0,
tonEarned: 0, // âœ¨ NEW: Track total TON earned
referrals: 0,
referralCode: "",
ownedWeapons: ["sword"],
ownedChars: ["hero"],
soundEnabled: true,
tonWallet: "", // âœ¨ NEW: TON wallet address
lastDaily: 0, // âœ¨ NEW: Last daily claim timestamp
lastSpin: 0 // âœ¨ NEW: Last spin timestamp
};

let zombie = {hp: 30, max: 30};

// Skills State
let skills = {
damage: {level: 0, max: 5},
hp: {level: 0, max: 5},
crit: {level: 0, max: 3}
};

// âœ¨ NEW: Weekly Tasks State
let tasks = {
task1: {completed: false, title: "Kill 50 Zombies", target: 50, progress: 0},
task2: {completed: false, title: "Reach Level 10", target: 10, progress: 0},
task3: {completed: false, title: "Earn 5,000 Coins", target: 5000, progress: 0},
task4: {completed: false, title: "Upgrade Any Skill", target: 1, progress: 0},
task5: {completed: false, title: "Unlock 2 Weapons", target: 2, progress: 0},
lastReset: Date.now()
};

// Weapons Data
let weapons = {
sword: {name: "Basic Sword", dmg: 10, price: 0, icon: "âš”ï¸", desc: "Starter weapon"},
axe: {name: "Battle Axe", dmg: 20, price: 100, icon: "ğŸª“", desc: "+10 damage"},
gun: {name: "Power Gun", dmg: 35, price: 300, icon: "ğŸ”«", desc: "+25 damage"},
laser: {name: "Laser Sword", dmg: 50, price: 600, icon: "ğŸ—¡ï¸", desc: "+40 damage"},
hammer: {name: "Thunder Hammer", dmg: 75, price: 1000, icon: "ğŸ”¨", desc: "+65 damage"}
};

// Characters Data
let characters = {
hero: {name: "Hero", icon: "ğŸ¦¸â€â™‚ï¸", hp: 100, level: 1, price: 0, desc: "Balanced fighter"},
ninja: {name: "Ninja", icon: "ğŸ¥·", hp: 80, level: 5, price: 200, desc: "Fast attacks"},
slayer: {name: "Slayer", icon: "ğŸ§”â€â™‚ï¸", hp: 150, level: 10, price: 500, desc: "High HP tank"},
wizard: {name: "Wizard", icon: "ğŸ§™â€â™‚ï¸", hp: 90, level: 15, price: 800, desc: "Magic damage"},
knight: {name: "Knight", icon: "ğŸ›¡ï¸", hp: 200, level: 20, price: 1200, desc: "Ultimate defense"}
};

// âœ¨ MODIFIED: Spin wheel with TON rewards
const wheelPrizes = [
{type: 'coins', value: 100},
{type: 'coins', value: 50},
{type: 'ton', value: 0.001},
{type: 'coins', value: 20},
{type: 'ton', value: 0.002},
{type: 'sorry', value: 0},
{type: 'coins', value: 30},
{type: 'ton', value: 0.003}
];
const wheelColors = ['#ffc107', '#4caf50', '#0088cc', '#9c27b0', '#0088cc', '#f44336', '#00bcd4', '#0088cc'];
let isSpinning = false;
let confirmCallback = null;

// âœ¨ NEW: Timer update interval
let timerInterval = null;

// Load saved data
function loadGame(){
let saved = localStorage.getItem("zombieFighterSave");
if(saved){
let data = JSON.parse(saved);
Object.assign(player, data.player);
Object.assign(skills, data.skills);
if(data.tasks) Object.assign(tasks, data.tasks);
// Ensure new properties exist
if(!player.xp) player.xp = 0;
if(!player.xpMax) player.xpMax = 100;
if(!player.baseMax) player.baseMax = 100;
if(!player.hpUpgrades) player.hpUpgrades = 0;
if(!player.ton) player.ton = 0;
if(!player.tonEarned) player.tonEarned = 0;
if(!player.tonWallet) player.tonWallet = "";
if(!player.lastDaily) player.lastDaily = 0;
if(!player.lastSpin) player.lastSpin = 0;
}
// Get Telegram username
if(tg && tg.initDataUnsafe?.user){
player.name = tg.initDataUnsafe.user.first_name || "Player";
}
// Generate referral code if not exists
if(!player.referralCode){
player.referralCode = "ZF" + Math.random().toString(36).substr(2, 6).toUpperCase();
}
// Check weekly tasks reset
checkTasksReset();
update();
startTimerUpdates();
}

// âœ¨ NEW: Check if tasks need weekly reset
function checkTasksReset(){
const weekInMs = 7 * 24 * 60 * 60 * 1000;
if(Date.now() - tasks.lastReset > weekInMs){
// Reset all tasks
for(let key in tasks){
if(tasks[key].completed !== undefined){
tasks[key].completed = false;
tasks[key].progress = 0;
}
}
tasks.lastReset = Date.now();
}
}

// Save game
function saveGame(){
localStorage.setItem("zombieFighterSave", JSON.stringify({
player: player,
skills: skills,
tasks: tasks
}));
}

// âœ¨ MODIFIED: Update UI with TON
function update(){
hp.textContent = player.hp;
hpmax.textContent = player.max;
hpbar.style.width = (player.hp / player.max * 100) + "%";

xp.textContent = player.xp;
xpmax.textContent = player.xpMax;
xpbar.style.width = (player.xp / player.xpMax * 100) + "%";

if(player.hp < player.max * 0.25){
hpLabel.classList.add('hp-low');
} else {
hpLabel.classList.remove('hp-low');
}

zhp.textContent = zombie.hp + "/" + zombie.max;
zbar.style.width = (zombie.hp / zombie.max * 100) + "%";
playerChar.textContent = characters[player.char].icon;
coins.textContent = player.coins;
ton.textContent = player.ton.toFixed(4); // âœ¨ Display TON balance
level.textContent = player.level;
playerName.textContent = player.name;
wheelCenter.textContent = characters[player.char].icon; // âœ¨ Update wheel center
saveGame();
updateTaskProgress();
}

// âœ¨ NEW: Update task progress
function updateTaskProgress(){
tasks.task1.progress = player.kills;
tasks.task2.progress = player.level;
tasks.task3.progress = player.coinsEarned;
tasks.task5.progress = player.ownedWeapons.length;
}

// âœ¨ NEW: Start timer updates
function startTimerUpdates(){
if(timerInterval) clearInterval(timerInterval);
timerInterval = setInterval(updateTimers, 1000);
}

// âœ¨ NEW: Update all timers
function updateTimers(){
// Update daily timer if modal is open
if(document.getElementById('dailyModal').classList.contains('show')){
updateDailyTimer();
}
// Update spin timer if modal is open
if(document.getElementById('spinModal').classList.contains('show')){
updateSpinTimer();
}
}

// Attack Function
function attack(){
if(player.hp <= 0){
toastMsg("âŒ You are dead! Heal first!");
return;
}

playerChar.classList.add("attack");
zombieChar.classList.add("hit");
sounds.play('attack');

let dmg = weapons[player.weapon].dmg;
dmg += skills.damage.level * 5;

let isCrit = Math.random() < (skills.crit.level * 0.1);
if(isCrit){
dmg *= 2;
floatText("ğŸ’¥ CRIT -" + dmg, zombieChar);
sounds.play('hit');
gameContainer.classList.add('shake');
setTimeout(() => gameContainer.classList.remove('shake'), 300);
} else {
floatText("-" + dmg, zombieChar);
sounds.play('hit');
}

zombie.hp -= dmg;

if(zombie.hp <= 0){
player.kills++;

let xpGain = 20 + Math.floor(player.level * 2);
player.xp += xpGain;
player.coins += 10;
player.coinsEarned += 10;
sounds.play('coin');

if(player.xp >= player.xpMax){
player.xp -= player.xpMax;
player.level++;
player.xpMax = Math.floor(100 + (player.level * 15));
sounds.play('levelup');
toastMsg("ğŸ‰ LEVEL UP! Level " + player.level);
gameContainer.classList.add('levelup');
setTimeout(() => gameContainer.classList.remove('levelup'), 800);
} else {
toastMsg(`+${xpGain}âš¡ +10ğŸ’°`);
}

sounds.play('death');
zombie.hp = zombie.max + Math.floor(player.level * 3);
zombie.max = zombie.hp;
}

setTimeout(() => {
let zombieDmg = 5 + Math.floor(player.level / 3);
player.hp = Math.max(0, player.hp - zombieDmg);
if(player.hp > 0){
floatText("-" + zombieDmg, playerChar);
}
if(player.hp === 0){
toastMsg("ğŸ’€ You died! Watching ad to revive...");
setTimeout(() => {
player.hp = player.max;
update();
toastMsg("âœ… Revived!");
}, 2000);
}
update();
}, 400);

setTimeout(() => {
playerChar.classList.remove("attack");
zombieChar.classList.remove("hit");
}, 200);

update();
}

// Floating Damage Text
function floatText(text, el){
let d = document.createElement("div");
d.className = "float";
d.textContent = text;
d.style.left = (Math.random() * 30 + 35) + "%";
d.style.top = "50%";
el.parentElement.style.position = "relative";
el.parentElement.appendChild(d);
setTimeout(() => d.remove(), 1000);
}

// Toast Notification
function toastMsg(t){
toast.textContent = t;
toast.classList.add("show");
setTimeout(() => toast.classList.remove("show"), 2000);
}

// Open/Close Modals
function openModal(id){
document.getElementById(id).classList.add("show");
}

function closeModal(id){
document.getElementById(id).classList.remove("show");
}

// WEAPONS PAGE
function openWeapons(){
let html = "";
for(let key in weapons){
let w = weapons[key];
let owned = player.ownedWeapons.includes(key);
let equipped = player.weapon === key;
let canBuy = player.coins >= w.price;

html += `<div class="item-card ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''}">
${equipped ? '<span class="badge">EQUIPPED</span>' : ''}
<div class="icon">${w.icon}</div>
<div class="name">${w.name}</div>
<div class="desc">${w.desc}</div>
<div class="desc">ğŸ’¥ Damage: ${w.dmg}</div>`;

if(!owned){
html += `<div class="price">ğŸ’° ${w.price}</div>
<button onclick="buyWeapon('${key}')" ${!canBuy ? 'disabled' : ''}>
${canBuy ? 'Buy' : 'Not enough coins'}
</button>`;
} else if(!equipped){
html += `<button onclick="equipWeapon('${key}')">Equip</button>`;
} else {
html += `<button style="background:#4caf50" disabled>Equipped</button>`;
}

html += `</div>`;
}
weaponsList.innerHTML = html;
openModal("weaponsModal");
}

function buyWeapon(key){
let w = weapons[key];
if(player.coins >= w.price && !player.ownedWeapons.includes(key)){
player.coins -= w.price;
player.ownedWeapons.push(key);
sounds.play('coin');
toastMsg(`âœ… Bought ${w.name}!`);
update();
openWeapons();
}
}

function equipWeapon(key){
if(player.ownedWeapons.includes(key)){
player.weapon = key;
toastMsg(`âš”ï¸ Equipped ${weapons[key].name}!`);
update();
openWeapons();
}
}

// CHARACTERS PAGE
function openCharacters(){
let html = "";
for(let key in characters){
let c = characters[key];
let owned = player.ownedChars.includes(key);
let equipped = player.char === key;
let unlocked = player.level >= c.level;
let canBuy = player.coins >= c.price && unlocked;

html += `<div class="item-card ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''}">
${equipped ? '<span class="badge">ACTIVE</span>' : ''}
<div class="icon">${c.icon}</div>
<div class="name">${c.name}</div>
<div class="desc">${c.desc}</div>
<div class="desc">â¤ï¸ HP: ${c.hp}</div>`;

if(!owned){
if(!unlocked){
html += `<div class="price">ğŸ”’ Level ${c.level}</div>
<button disabled>Locked</button>`;
} else {
html += `<div class="price">ğŸ’° ${c.price}</div>
<button onclick="buyCharacter('${key}')" ${!canBuy ? 'disabled' : ''}>
${canBuy ? 'Buy' : 'Not enough coins'}
</button>`;
}
} else if(!equipped){
html += `<button onclick="equipCharacter('${key}')">Select</button>`;
} else {
html += `<button style="background:#4caf50" disabled>Active</button>`;
}

html += `</div>`;
}
charactersList.innerHTML = html;
openModal("charactersModal");
}

function buyCharacter(key){
let c = characters[key];
if(player.coins >= c.price && player.level >= c.level && !player.ownedChars.includes(key)){
player.coins -= c.price;
player.ownedChars.push(key);
sounds.play('coin');
toastMsg(`âœ… Unlocked ${c.name}!`);
update();
openCharacters();
}
}

function equipCharacter(key){
if(player.ownedChars.includes(key)){
player.char = key;
recalculateMaxHP();
player.hp = Math.min(player.hp, player.max);
toastMsg(`âœ… Selected ${characters[key].name}!`);
update();
openCharacters();
}
}

function recalculateMaxHP(){
player.baseMax = characters[player.char].hp;
player.max = player.baseMax + (player.hpUpgrades * 20) + (skills.hp.level * 20);
}

// âœ¨ MODIFIED: Skills page with TON
function openSkills(){
let hpUpgradeCost = (player.hpUpgrades + 1) * 80;
let html = `
<div class="skill-item" style="border-color:#ff5252">
<div class="skill-header">
<span class="skill-name">â¤ï¸ HP Upgrade</span>
<span class="skill-level">+${player.hpUpgrades * 20} HP</span>
</div>
<div class="skill-desc">Permanently increase Max HP by 20</div>
<div class="skill-desc">Cost: ${hpUpgradeCost} ğŸ’°</div>
<button onclick="upgradeHP()">Upgrade Max HP</button>
</div>

<!-- âœ¨ NEW: Coin to TON Conversion -->
<div class="skill-item" style="border-color:#0088cc">
<div class="skill-header">
<span class="skill-name">ğŸ’ Convert to TON</span>
</div>
<div class="skill-desc">Convert 10,000 ğŸ’° â†’ 0.2 TON</div>
<div class="skill-desc">Your coins: ${player.coins}</div>
<button onclick="convertCoinsToTON()">Convert Now</button>
</div>

<div class="skill-item">
<div class="skill-header">
<span class="skill-name">ğŸ’¥ Damage Boost</span>
<span class="skill-level">Lv ${skills.damage.level}/${skills.damage.max}</span>
</div>
<div class="skill-desc">+5 damage per level</div>
<div class="skill-desc">Cost: ${(skills.damage.level + 1) * 50} ğŸ’°</div>
<button onclick="upgradeSkill('damage')" ${skills.damage.level >= skills.damage.max ? 'disabled' : ''}>
${skills.damage.level >= skills.damage.max ? 'MAX' : 'Upgrade'}
</button>
</div>

<div class="skill-item">
<div class="skill-header">
<span class="skill-name">â¤ï¸ HP Boost</span>
<span class="skill-level">Lv ${skills.hp.level}/${skills.hp.max}</span>
</div>
<div class="skill-desc">+20 max HP per level</div>
<div class="skill-desc">Cost: ${(skills.hp.level + 1) * 60} ğŸ’°</div>
<button onclick="upgradeSkill('hp')" ${skills.hp.level >= skills.hp.max ? 'disabled' : ''}>
${skills.hp.level >= skills.hp.max ? 'MAX' : 'Upgrade'}
</button>
</div>

<div class="skill-item">
<div class="skill-header">
<span class="skill-name">âš¡ Critical Hit</span>
<span class="skill-level">Lv ${skills.crit.level}/${skills.crit.max}</span>
</div>
<div class="skill-desc">+10% crit chance (2x damage)</div>
<div class="skill-desc">Cost: ${(skills.crit.level + 1) * 0.01} ğŸ’ TON</div>
<button onclick="upgradeSkill('crit')" ${skills.crit.level >= skills.crit.max ? 'disabled' : ''}>
${skills.crit.level >= skills.crit.max ? 'MAX' : 'Upgrade'}
</button>
</div>
`;
skillsList.innerHTML = html;
openModal("skillsModal");
}

// âœ¨ NEW: Convert coins to TON
function convertCoinsToTON(){
if(player.coins >= 10000){
player.coins -= 10000;
player.ton += 0.2;
player.tonEarned += 0.2;
sounds.play('levelup');
toastMsg("âœ… Converted to 0.2 TON!");
update();
openSkills();
} else {
toastMsg("âŒ Need 10,000 coins!");
}
}

function upgradeHP(){
let cost = (player.hpUpgrades + 1) * 80;
if(player.coins >= cost){
player.coins -= cost;
player.hpUpgrades++;
recalculateMaxHP();
player.hp = player.max;
sounds.play('levelup');
toastMsg(`âœ… Max HP increased to ${player.max}!`);
update();
openSkills();
} else {
toastMsg("âŒ Not enough coins!");
}
}

// âœ¨ MODIFIED: Crit skill costs TON
function upgradeSkill(type){
let cost = (skills[type].level + 1) * (type === 'crit' ? 0.01 : (type === 'hp' ? 60 : 50));
let currency = type === 'crit' ? 'ton' : 'coins';

if(player[currency] >= cost && skills[type].level < skills[type].max){
player[currency] -= cost;
skills[type].level++;

if(type === 'hp'){
recalculateMaxHP();
player.hp = player.max;
}

// Track task progress
if(type !== 'crit'){
tasks.task4.progress++;
if(tasks.task4.progress >= tasks.task4.target) tasks.task4.completed = true;
}

sounds.play('levelup');
toastMsg(`âœ… Skill upgraded!`);
update();
openSkills();
} else {
toastMsg(`âŒ Not enough ${currency}!`);
}
}

// âœ¨ MODIFIED: STATS PAGE with TON
function openStats(){
let html = `
<div class="stat-row">
<span class="label">â­ Level</span>
<span class="value">${player.level}</span>
</div>
<div class="stat-row">
<span class="label">âš¡ XP Progress</span>
<span class="value">${player.xp}/${player.xpMax}</span>
</div>
<div class="stat-row">
<span class="label">â˜ ï¸ Total Kills</span>
<span class="value">${player.kills}</span>
</div>
<div class="stat-row">
<span class="label">ğŸ’° Coins Earned</span>
<span class="value">${player.coinsEarned}</span>
</div>
<div class="stat-row">
<span class="label">ğŸ’ TON Earned</span>
<span class="value">${player.tonEarned.toFixed(4)}</span>
</div>
<div class="stat-row">
<span class="label">âš”ï¸ Weapons Owned</span>
<span class="value">${player.ownedWeapons.length}/${Object.keys(weapons).length}</span>
</div>
<div class="stat-row">
<span class="label">ğŸ§™ Characters Unlocked</span>
<span class="value">${player.ownedChars.length}/${Object.keys(characters).length}</span>
</div>
<div class="stat-row">
<span class="label">ğŸ‘¥ Referrals</span>
<span class="value">${player.referrals}</span>
</div>
`;
statsList.innerHTML = html;
openModal("statsModal");
}

// âœ¨ MODIFIED: SETTINGS PAGE with TON wallet and withdrawal
function openSettings(){
let walletDisplay = player.tonWallet ? 
`<div class="wallet-status wallet-connected">âœ… Connected: ${player.tonWallet.substring(0,8)}...${player.tonWallet.substring(player.tonWallet.length-6)}</div>` :
`<div class="wallet-status wallet-disconnected">âš ï¸ No wallet connected</div>`;

let html = `
<div class="setting-item">
<label>
<span>ğŸ‘¤ Player Name</span>
</label>
<input type="text" id="nameInput" value="${player.name}" onchange="changeName(this.value)">
</div>

<!-- âœ¨ NEW: TON Wallet Connection -->
<div class="setting-item">
<label>
<span>ğŸ’ TON Wallet</span>
</label>
${walletDisplay}
<input type="text" id="walletInput" placeholder="Enter TON wallet address" value="${player.tonWallet}" style="margin-top:8px">
<button onclick="connectWallet()" style="width:100%;margin-top:8px">
${player.tonWallet ? 'ğŸ”„ Update Wallet' : 'ğŸ”— Connect Wallet'}
</button>
</div>

<!-- âœ¨ NEW: Withdrawal Option -->
<div class="setting-item">
<button onclick="openWithdrawal()" style="width:100%;background:#0088cc;padding:12px">
ğŸ’¸ Withdraw TON
</button>
</div>

<div class="setting-item">
<label>
<span>ğŸ”Š Sound Effects</span>
<input type="checkbox" ${player.soundEnabled ? 'checked' : ''} onchange="toggleSound(this.checked)">
</label>
</div>

<div class="setting-item">
<button onclick="showResetConfirm()" style="width:100%;background:#ff5252;padding:12px">
ğŸ—‘ï¸ Reset Game Progress
</button>
</div>
`;
settingsList.innerHTML = html;
openModal("settingsModal");
}

// âœ¨ NEW: Connect TON Wallet
function connectWallet(){
let walletInput = document.getElementById('walletInput').value.trim();
if(walletInput.length < 10){
toastMsg("âŒ Invalid wallet address!");
return;
}
player.tonWallet = walletInput;
toastMsg("âœ… Wallet connected!");
update();
openSettings();
}

// âœ¨ NEW: Open Withdrawal Modal
function openWithdrawal(){
if(!player.tonWallet){
toastMsg("âŒ Connect wallet first!");
return;
}

let minWithdraw = 0.1;
let html = `
<div class="wallet-status">
<strong>Your Balance:</strong> ${player.ton.toFixed(4)} TON
</div>

<div class="stat-row">
<span class="label">ğŸ’ Wallet Address</span>
<span class="value" style="font-size:11px">${player.tonWallet.substring(0,12)}...</span>
</div>

<div class="stat-row">
<span class="label">âš ï¸ Minimum Withdrawal</span>
<span class="value">${minWithdraw} TON</span>
</div>

<div style="margin:15px 0;padding:10px;background:rgba(255,152,0,0.2);border-radius:8px;font-size:13px">
âš ï¸ Withdrawals are processed manually within 24-48 hours.
</div>

<button onclick="requestWithdrawal()" style="width:100%;padding:12px;margin-top:10px" ${player.ton < minWithdraw ? 'disabled' : ''}>
${player.ton >= minWithdraw ? 'ğŸ’¸ Request Withdrawal' : 'âŒ Insufficient Balance'}
</button>
`;
withdrawContent.innerHTML = html;
closeModal('settingsModal');
openModal("withdrawModal");
}

// âœ¨ NEW: Request Withdrawal
function requestWithdrawal(){
let minWithdraw = 0.1;
if(player.ton < minWithdraw){
toastMsg("âŒ Minimum withdrawal is 0.1 TON!");
return;
}

confirmCallback = () => {
let amount = player.ton;
player.ton = 0;
toastMsg(`âœ… Withdrawal of ${amount.toFixed(4)} TON requested!`);
update();
closeModal("withdrawModal");
};

showConfirmDialog(
"ğŸ’¸ Confirm Withdrawal?",
`Withdraw ${player.ton.toFixed(4)} TON to your wallet?`
);
}

function changeName(name){
if(name.trim()){
player.name = name.trim();
update();
toastMsg("âœ… Name updated!");
}
}

function toggleSound(enabled){
player.soundEnabled = enabled;
saveGame();
toastMsg(enabled ? "ğŸ”Š Sound ON" : "ğŸ”‡ Sound OFF");
}

function showResetConfirm(){
closeModal("settingsModal");
confirmCallback = confirmReset;
showConfirmDialog("âš ï¸ Reset Game?", "This will delete all progress!");
}

function confirmReset(){
localStorage.removeItem("zombieFighterSave");
location.reload();
}

// âœ¨ NEW: Generic confirm dialog
function showConfirmDialog(title, message){
confirmContent.innerHTML = `
<h3>${title}</h3>
<p>${message}</p>
<div class="buttons">
<button onclick="closeModal('confirmModal')">Cancel</button>
<button onclick="confirmAction()" style="background:#ff5252">Confirm</button>
</div>
`;
openModal("confirmModal");
}

function confirmAction(){
if(confirmCallback){
confirmCallback();
confirmCallback = null;
}
closeModal("confirmModal");
}

// âœ¨ MODIFIED: REFERRAL PAGE with TON rewards
function openReferral(){
let botUsername = "YourBotUsername";
let referralLink = `https://t.me/${botUsername}?start=${player.referralCode}`;

let html = `
<div class="referral-code">
<div>Your Referral Code</div>
<div class="code">${player.referralCode}</div>
<div style="font-size:12px;color:#aaa;margin-top:10px">
Share with friends to earn rewards!
</div>
</div>

<div class="stat-row">
<span class="label">ğŸ‘¥ Total Referrals</span>
<span class="value">${player.referrals}</span>
</div>

<div class="stat-row">
<span class="label">ğŸ Reward per Friend</span>
<span class="value">50 ğŸ’° + 0.005 ğŸ’ TON</span>
</div>

<button onclick="shareReferral('${referralLink}')" style="width:100%;padding:12px;margin-top:15px">
ğŸ“¤ Share on Telegram
</button>

<div style="margin-top:15px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px;color:#aaa">
ğŸ’¡ How it works:<br>
1. Share your code with friends<br>
2. They join using your link<br>
3. You both get rewards!
</div>
`;
referralContent.innerHTML = html;
openModal("referralModal");
}

function shareReferral(link){
if(tg){
tg.openTelegramLink(link);
toastMsg("ğŸ“¤ Opening Telegram...");
} else {
navigator.clipboard.writeText(link);
toastMsg("ğŸ“‹ Link copied to clipboard!");
}
}

// âœ¨ NEW: Daily Reward Modal with Timer
function openDaily(){
updateDailyTimer();
openModal("dailyModal");
}

function updateDailyTimer(){
const dayInMs = 24 * 60 * 60 * 1000;
const timeSinceLast = Date.now() - player.lastDaily;
const canClaim = timeSinceLast >= dayInMs;

let html = '';
if(canClaim){
html = `
<div style="text-align:center;padding:20px">
<div style="font-size:60px;margin:20px 0">ğŸ</div>
<h3>Daily Reward Available!</h3>
<div class="stat-row">
<span class="label">ğŸ’° Coins</span>
<span class="value">+50</span>
</div>
<div class="stat-row">
<span class="label">ğŸ’ TON</span>
<span class="value">+0.005</span>
</div>
<button onclick="claimDaily()" style="width:100%;padding:15px;margin-top:15px;background:#4caf50">
ğŸ Claim Reward
</button>
</div>
`;
} else {
const timeLeft = dayInMs - timeSinceLast;
const hours = Math.floor(timeLeft / (60 * 60 * 1000));
const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);

html = `
<div style="text-align:center;padding:20px">
<div style="font-size:60px;margin:20px 0;opacity:0.5">ğŸ</div>
<h3>Daily Reward</h3>
<p style="color:#aaa">Come back later to claim your reward!</p>
<div class="timer-display" style="font-size:32px;margin:20px 0">
${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}
</div>
<button disabled style="width:100%;padding:15px;margin-top:15px">
â° Already Claimed Today
</button>
</div>
`;
}
dailyContent.innerHTML = html;
}

// âœ¨ NEW: Claim Daily Reward
function claimDaily(){
player.coins += 50;
player.ton += 0.005;
player.coinsEarned += 50;
player.tonEarned += 0.005;
player.lastDaily = Date.now();
sounds.play('coin');
toastMsg("ğŸ Daily Reward: +50ğŸ’° +0.005ğŸ’ TON");
update();
closeModal("dailyModal");
}

// âœ¨ MODIFIED: Spin Wheel with Timer and Character Center
function openSpinWheel(){
initWheel();
updateSpinTimer();
openModal("spinModal");
}

function initWheel(){
let wheel = document.getElementById('wheel');
wheel.innerHTML = '';

const sliceAngle = 360 / wheelPrizes.length;
wheelPrizes.forEach((prize, i) => {
let slice = document.createElement('div');
slice.className = 'wheel-slice';
slice.style.background = wheelColors[i];
slice.style.transform = `rotate(${i * sliceAngle}deg)`;
let text = '';
if(prize.type === 'sorry'){
text = 'ğŸ˜…';
} else if(prize.type === 'ton'){
text = prize.value + 'ğŸ’';
} else {
text = prize.value + 'ğŸ’°';
}
slice.innerHTML = `<span style="transform:rotate(22.5deg);display:inline-block;font-size:14px">${text}</span>`;
wheel.appendChild(slice);
});
}

function updateSpinTimer(){
const dayInMs = 24 * 60 * 60 * 1000;
const timeSinceLast = Date.now() - player.lastSpin;
const canSpin = timeSinceLast >= dayInMs;

let button = document.getElementById('spinButton');
let timer = document.getElementById('spinTimer');

if(canSpin){
button.disabled = false;
button.textContent = 'ğŸ° SPIN (Free)';
timer.textContent = '';
} else {
const timeLeft = dayInMs - timeSinceLast;
const hours = Math.floor(timeLeft / (60 * 60 * 1000));
const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);

button.disabled = true;
button.textContent = 'â° Already Used Today';
timer.textContent = `Next spin in: ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
}
}

// âœ¨ MODIFIED: Spin wheel animation with TON rewards
function spinWheel(){
const dayInMs = 24 * 60 * 60 * 1000;
if(Date.now() - player.lastSpin < dayInMs){
toastMsg("â° Wait 24 hours!");
return;
}
if(isSpinning) return;
isSpinning = true;

let wheel = document.getElementById('wheel');
let button = document.getElementById('spinButton');
let result = document.getElementById('spinResult');
button.disabled = true;
result.textContent = '';
sounds.play('spin');

let extraSpins = 5 + Math.floor(Math.random() * 3);
let randomSlice = Math.floor(Math.random() * wheelPrizes.length);
let sliceAngle = 360 / wheelPrizes.length;
let finalRotation = (extraSpins * 360) + (randomSlice * sliceAngle) + (sliceAngle / 2);

wheel.style.transform = `rotate(${finalRotation}deg)`;

let tickInterval = setInterval(() => {
sounds.play('spin');
}, 100);

setTimeout(() => {
clearInterval(tickInterval);
let prizeIndex = (wheelPrizes.length - randomSlice) % wheelPrizes.length;
let prize = wheelPrizes[prizeIndex];

if(prize.type === 'coins'){
player.coins += prize.value;
player.coinsEarned += prize.value;
sounds.play('coin');
result.textContent = `ğŸ‰ You won ${prize.value} coins!`;
toastMsg(`ğŸ¡ +${prize.value}ğŸ’°`);
} else if(prize.type === 'ton'){
player.ton += prize.value;
player.tonEarned += prize.value;
sounds.play('coin');
result.textContent = `ğŸ’ You won ${prize.value} TON!`;
toastMsg(`ğŸ¡ +${prize.value}ğŸ’ TON`);
} else {
result.textContent = `ğŸ˜… Better luck next time!`;
toastMsg(`ğŸ¡ No prize this time`);
}

player.lastSpin = Date.now();
update();
isSpinning = false;
updateSpinTimer();
}, 3000);
}

// âœ¨ NEW: Weekly Tasks System
function openTasks(){
let html = `
<div style="padding:10px;background:rgba(0,136,204,0.2);border-radius:8px;margin-bottom:15px;text-align:center">
<strong>Complete ALL tasks to earn 0.32 TON bonus!</strong>
</div>
`;

let allCompleted = true;
for(let key in tasks){
if(tasks[key].title){
let t = tasks[key];
let progress = Math.min(t.progress, t.target);
let completed = t.completed || progress >= t.target;
if(!completed) allCompleted = false;

html += `
<div class="task-item ${completed ? 'completed' : ''}">
<div class="task-header">
<span class="task-title">${completed ? 'âœ…' : 'â­•'} ${t.title}</span>
</div>
<div class="task-reward">Reward: 1000 ğŸ’° + 0.003 ğŸ’ TON</div>
<div style="font-size:12px;color:#aaa;margin:5px 0">Progress: ${progress}/${t.target}</div>
<button onclick="claimTask('${key}')" ${completed && !t.claimed ? '' : 'disabled'}>
${t.claimed ? 'Claimed' : (completed ? 'Claim Reward' : 'Incomplete')}
</button>
</div>
`;
}
}

// Bonus reward button
html += `
<div class="task-item" style="border-color:#ffc107;background:rgba(255,193,7,0.1)">
<div class="task-header">
<span class="task-title">ğŸ Complete All Tasks Bonus</span>
</div>
<div class="task-reward">Bonus: 0.32 ğŸ’ TON</div>
<button onclick="claimAllBonus()" ${allCompleted && !tasks.allBonus ? '' : 'disabled'}>
${tasks.allBonus ? 'Claimed' : (allCompleted ? 'Claim Bonus' : 'Complete all tasks first')}
</button>
</div>

<div style="margin-top:15px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:12px;color:#aaa;text-align:center">
â° Tasks reset every 7 days
</div>
`;

tasksContent.innerHTML = html;
openModal("tasksModal");
}

// âœ¨ NEW: Claim individual task
function claimTask(taskKey){
let t = tasks[taskKey];
if(t.progress >= t.target && !t.claimed){
player.coins += 1000;
player.ton += 0.003;
player.coinsEarned += 1000;
player.tonEarned += 0.003;
t.claimed = true;
t.completed = true;
sounds.play('coin');
toastMsg("âœ… Task reward claimed!");
update();
openTasks();
}
}

// âœ¨ NEW: Claim all tasks bonus
function claimAllBonus(){
let allCompleted = true;
for(let key in tasks){
if(tasks[key].title && !tasks[key].completed){
allCompleted = false;
break;
}
}

if(allCompleted && !tasks.allBonus){
player.ton += 0.32;
player.tonEarned += 0.32;
tasks.allBonus = true;
sounds.play('levelup');
toastMsg("ğŸ‰ Bonus claimed: +0.32 TON!");
update();
openTasks();
}
}

// âœ¨ NEW: In-Game Shop
function openShop(){
let html = `
<div style="text-align:center;padding:10px;background:rgba(0,136,204,0.2);border-radius:8px;margin-bottom:15px">
<h3>ğŸ’ TON Shop ğŸ˜€</h3>
<p style="font-size:12px;color:#aaa">Purchase items with TON</p>
</div>

<div class="item-grid">
<div class="item-card">
<div class="icon">ğŸ’°</div>
<div class="name">Coin Pack</div>
<div class="desc">Get 5,000 coins instantly</div>
<div class="price">0.05 ğŸ’ TON</div>
<button onclick="buyShopItem('coins', 5000, 0.05)">Purchase</button>
</div>

<div class="item-card">
<div class="icon">âš¡</div>
<div class="name">XP Boost</div>
<div class="desc">Gain 1000 XP instantly</div>
<div class="price">0.03 ğŸ’ TON</div>
<button onclick="buyShopItem('xp', 1000, 0.03)">Purchase</button>
</div>

<div class="item-card">
<div class="icon">â¤ï¸</div>
<div class="name">HP Refill</div>
<div class="desc">Restore HP to maximum</div>
<div class="price">0.01 ğŸ’ TON</div>
<button onclick="buyShopItem('hp', 0, 0.01)">Purchase</button>
</div>

<div class="item-card">
<div class="icon">ğŸ</div>
<div class="name">Mega Pack</div>
<div class="desc">10K coins + 2000 XP</div>
<div class="price">0.1 ğŸ’ TON</div>
<button onclick="buyShopItem('mega', 0, 0.1)">Purchase</button>
</div>
</div>

<div style="margin-top:15px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:12px;color:#aaa">
ğŸ’¡ This is a simulation. No real payments are processed.
</div>
`;
shopContent.innerHTML = html;
openModal("shopModal");
}

// âœ¨ NEW: Buy shop item
function buyShopItem(type, value, cost){
if(player.ton < cost){
toastMsg("âŒ Insufficient TON!");
return;
}

confirmCallback = () => {
player.ton -= cost;
sounds.play('coin');

switch(type){
case 'coins':
player.coins += value;
toastMsg(`âœ… Purchased ${value} coins!`);
break;
case 'xp':
player.xp += value;
if(player.xp >= player.xpMax){
player.xp -= player.xpMax;
player.level++;
player.xpMax = Math.floor(100 + (player.level * 15));
}
toastMsg(`âœ… Gained ${value} XP!`);
break;
case 'hp':
player.hp = player.max;
toastMsg("âœ… HP restored!");
break;
case 'mega':
player.coins += 10000;
player.xp += 2000;
if(player.xp >= player.xpMax){
player.xp -= player.xpMax;
player.level++;
player.xpMax = Math.floor(100 + (player.level * 15));
}
toastMsg("âœ… Mega Pack purchased!");
break;
}

update();
closeModal("shopModal");
};

showConfirmDialog("ğŸ›’ Confirm Purchase?", `Spend ${cost} TON on this item?`);
}

// Reward Functions
function watchAd(){
player.coins += 20;
player.ton += 0.002;
player.coinsEarned += 20;
player.tonEarned += 0.002;
sounds.play('coin');
toastMsg("ğŸ“º +20ğŸ’° +0.002ğŸ’ TON");
update();
}

// Initialize Game
initSounds();
loadGame();
</script>
</body>
</html>
